<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Ocean Metrics Team">

<title>Ocean Metrics Indicators Data Ingestion Workflow</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="ingest_indicators_files/libs/clipboard/clipboard.min.js"></script>
<script src="ingest_indicators_files/libs/quarto-html/quarto.js"></script>
<script src="ingest_indicators_files/libs/quarto-html/popper.min.js"></script>
<script src="ingest_indicators_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="ingest_indicators_files/libs/quarto-html/anchor.min.js"></script>
<link href="ingest_indicators_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="ingest_indicators_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="ingest_indicators_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="ingest_indicators_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="ingest_indicators_files/libs/bootstrap/bootstrap-c0367b04c37547644fece4185067e4a7.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="ingest_indicators_files/libs/quarto-diagram/mermaid.min.js"></script>
<script src="ingest_indicators_files/libs/quarto-diagram/mermaid-init.js"></script>
<link href="ingest_indicators_files/libs/quarto-diagram/mermaid.css" rel="stylesheet">
<script src="ingest_indicators_files/libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="ingest_indicators_files/libs/maplibre-gl-5.5.0/maplibre-gl.css" rel="stylesheet">
<script src="ingest_indicators_files/libs/maplibre-gl-5.5.0/maplibre-gl.js"></script>
<link href="ingest_indicators_files/libs/mapbox-gl-draw-1.5.0/mapbox-gl-draw.css" rel="stylesheet">
<script src="ingest_indicators_files/libs/mapbox-gl-draw-1.5.0/mapbox-gl-draw.js"></script>
<script src="ingest_indicators_files/libs/freehand-mode-1.0.0/freehand-mode.js"></script>
<link href="ingest_indicators_files/libs/maplibre-gl-geocoder-1.5.0/maplibre-gl-geocoder.css" rel="stylesheet">
<script src="ingest_indicators_files/libs/maplibre-gl-geocoder-1.5.0/maplibre-gl-geocoder.min.js"></script>
<script src="ingest_indicators_files/libs/mapbox-gl-globe-minimap-1.2.1/bundle.js"></script>
<script src="ingest_indicators_files/libs/pmtiles-3.2.0/pmtiles.js"></script>
<script src="ingest_indicators_files/libs/h3j-h3t-0.9.2/h3j_h3t.js"></script>
<script src="ingest_indicators_files/libs/maplibregl-binding-0.2.2.9000/maplibregl.js"></script>
<link href="ingest_indicators_files/libs/layers-control-1.0.0/layers-control.css" rel="stylesheet">


</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="1">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a>
  <ul class="collapse">
  <li><a href="#data-source" id="toc-data-source" class="nav-link" data-scroll-target="#data-source"><span class="header-section-number">1.1</span> Data Source</a></li>
  <li><a href="#workflow-goals" id="toc-workflow-goals" class="nav-link" data-scroll-target="#workflow-goals"><span class="header-section-number">1.2</span> Workflow Goals</a></li>
  <li><a href="#key-challenges-considerations" id="toc-key-challenges-considerations" class="nav-link" data-scroll-target="#key-challenges-considerations"><span class="header-section-number">1.3</span> Key Challenges &amp; Considerations</a></li>
  </ul></li>
  <li><a href="#data-processing-pipeline" id="toc-data-processing-pipeline" class="nav-link" data-scroll-target="#data-processing-pipeline"><span class="header-section-number">2</span> Data Processing Pipeline</a></li>
  <li><a href="#environment-setup" id="toc-environment-setup" class="nav-link" data-scroll-target="#environment-setup"><span class="header-section-number">3</span> Environment Setup</a>
  <ul class="collapse">
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link" data-scroll-target="#prerequisites"><span class="header-section-number">3.1</span> Prerequisites</a></li>
  <li><a href="#load-required-libraries-and-configure-paths" id="toc-load-required-libraries-and-configure-paths" class="nav-link" data-scroll-target="#load-required-libraries-and-configure-paths"><span class="header-section-number">3.2</span> Load Required Libraries and Configure Paths</a></li>
  <li><a href="#database-connection" id="toc-database-connection" class="nav-link" data-scroll-target="#database-connection"><span class="header-section-number">3.3</span> Database Connection</a></li>
  </ul></li>
  <li><a href="#data-transformation" id="toc-data-transformation" class="nav-link" data-scroll-target="#data-transformation"><span class="header-section-number">4</span> Data Transformation</a>
  <ul class="collapse">
  <li><a href="#overview-of-transformation-process" id="toc-overview-of-transformation-process" class="nav-link" data-scroll-target="#overview-of-transformation-process"><span class="header-section-number">4.1</span> Overview of Transformation Process</a></li>
  <li><a href="#parse-shapefiles-and-extract-metadata" id="toc-parse-shapefiles-and-extract-metadata" class="nav-link" data-scroll-target="#parse-shapefiles-and-extract-metadata"><span class="header-section-number">4.2</span> Parse Shapefiles and Extract Metadata</a></li>
  <li><a href="#extract-geometry-and-transform-to-long-format" id="toc-extract-geometry-and-transform-to-long-format" class="nav-link" data-scroll-target="#extract-geometry-and-transform-to-long-format"><span class="header-section-number">4.3</span> Extract Geometry and Transform to Long Format</a></li>
  <li><a href="#generate-layer-metadata-and-keys" id="toc-generate-layer-metadata-and-keys" class="nav-link" data-scroll-target="#generate-layer-metadata-and-keys"><span class="header-section-number">4.4</span> Generate Layer Metadata and Keys</a></li>
  <li><a href="#transform-to-wide-format" id="toc-transform-to-wide-format" class="nav-link" data-scroll-target="#transform-to-wide-format"><span class="header-section-number">4.5</span> Transform to Wide Format</a></li>
  <li><a href="#combine-data-with-geometry" id="toc-combine-data-with-geometry" class="nav-link" data-scroll-target="#combine-data-with-geometry"><span class="header-section-number">4.6</span> Combine Data with Geometry</a></li>
  <li><a href="#store-in-postgresqlpostgis-database" id="toc-store-in-postgresqlpostgis-database" class="nav-link" data-scroll-target="#store-in-postgresqlpostgis-database"><span class="header-section-number">4.7</span> Store in PostgreSQL/PostGIS Database</a></li>
  </ul></li>
  <li><a href="#visualize-with-mapgl" id="toc-visualize-with-mapgl" class="nav-link" data-scroll-target="#visualize-with-mapgl"><span class="header-section-number">5</span> Visualize with <code>mapgl</code></a></li>
  <li><a href="#vector-tile-generation-archived" id="toc-vector-tile-generation-archived" class="nav-link" data-scroll-target="#vector-tile-generation-archived"><span class="header-section-number">6</span> Vector Tile Generation (Archived)</a>
  <ul class="collapse">
  <li><a href="#background-on-vector-tiles" id="toc-background-on-vector-tiles" class="nav-link" data-scroll-target="#background-on-vector-tiles"><span class="header-section-number">6.1</span> Background on Vector Tiles</a></li>
  </ul></li>
  <li><a href="#additional-data-sources" id="toc-additional-data-sources" class="nav-link" data-scroll-target="#additional-data-sources"><span class="header-section-number">7</span> Additional Data Sources</a>
  <ul class="collapse">
  <li><a href="#world-database-on-protected-areas-wdpa" id="toc-world-database-on-protected-areas-wdpa" class="nav-link" data-scroll-target="#world-database-on-protected-areas-wdpa"><span class="header-section-number">7.1</span> World Database on Protected Areas (WDPA)</a></li>
  </ul></li>
  <li><a href="#todo-lists-and-recommendations" id="toc-todo-lists-and-recommendations" class="nav-link" data-scroll-target="#todo-lists-and-recommendations"><span class="header-section-number">8</span> TODO Lists and Recommendations</a>
  <ul class="collapse">
  <li><a href="#high-priority-tasks" id="toc-high-priority-tasks" class="nav-link" data-scroll-target="#high-priority-tasks"><span class="header-section-number">8.1</span> High Priority Tasks</a></li>
  <li><a href="#medium-priority-tasks" id="toc-medium-priority-tasks" class="nav-link" data-scroll-target="#medium-priority-tasks"><span class="header-section-number">8.2</span> Medium Priority Tasks</a></li>
  <li><a href="#low-priority-enhancements" id="toc-low-priority-enhancements" class="nav-link" data-scroll-target="#low-priority-enhancements"><span class="header-section-number">8.3</span> Low Priority Enhancements</a></li>
  </ul></li>
  <li><a href="#key-questions-for-stakeholders" id="toc-key-questions-for-stakeholders" class="nav-link" data-scroll-target="#key-questions-for-stakeholders"><span class="header-section-number">9</span> Key Questions for Stakeholders</a>
  <ul class="collapse">
  <li><a href="#data-management" id="toc-data-management" class="nav-link" data-scroll-target="#data-management"><span class="header-section-number">9.1</span> Data Management</a></li>
  <li><a href="#technical-architecture" id="toc-technical-architecture" class="nav-link" data-scroll-target="#technical-architecture"><span class="header-section-number">9.2</span> Technical Architecture</a></li>
  <li><a href="#quality-validation" id="toc-quality-validation" class="nav-link" data-scroll-target="#quality-validation"><span class="header-section-number">9.3</span> Quality &amp; Validation</a></li>
  <li><a href="#visualization-access" id="toc-visualization-access" class="nav-link" data-scroll-target="#visualization-access"><span class="header-section-number">9.4</span> Visualization &amp; Access</a></li>
  </ul></li>
  <li><a href="#notes-on-current-implementation" id="toc-notes-on-current-implementation" class="nav-link" data-scroll-target="#notes-on-current-implementation"><span class="header-section-number">10</span> Notes on Current Implementation</a>
  <ul class="collapse">
  <li><a href="#strengths" id="toc-strengths" class="nav-link" data-scroll-target="#strengths"><span class="header-section-number">10.1</span> Strengths</a></li>
  <li><a href="#areas-for-improvement" id="toc-areas-for-improvement" class="nav-link" data-scroll-target="#areas-for-improvement"><span class="header-section-number">10.2</span> Areas for Improvement</a></li>
  <li><a href="#recommendations-for-next-steps" id="toc-recommendations-for-next-steps" class="nav-link" data-scroll-target="#recommendations-for-next-steps"><span class="header-section-number">10.3</span> Recommendations for Next Steps</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Ocean Metrics Indicators Data Ingestion Workflow</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Ocean Metrics Team </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2025-06-06 00:00:00</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="overview" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="overview"><span class="header-section-number">1</span> Overview</h2>
<p>This workflow processes marine biodiversity indicator data from shapefiles into a structured format suitable for database storage and web visualization. The data includes various marine species groups (fish, sharks, rays, turtles) with seasonal variations and multiple indicator types.</p>
<section id="data-source" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="data-source"><span class="header-section-number">1.1</span> Data Source</h3>
<p>The input data consists of shapefiles containing:</p>
<ul>
<li><strong>Species Groups</strong>: Fish, Sharks, Rays, Red-listed species, Turtles, and All species combined</li>
<li><strong>Temporal Coverage</strong>: Summer and Winter seasons</li>
<li><strong>Indicator Types</strong>:
<ul>
<li>Cumulative Uncertainty</li>
<li>Rich Shape (species richness)</li>
<li>Weighted Rich Shape (weighted species richness)</li>
</ul></li>
</ul>
</section>
<section id="workflow-goals" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="workflow-goals"><span class="header-section-number">1.2</span> Workflow Goals</h3>
<ol type="1">
<li>Parse and standardize shapefile data from multiple files</li>
<li>Transform data into a normalized long format</li>
<li>Generate layer metadata with human-readable keys and descriptions</li>
<li>Store processed data in PostgreSQL/PostGIS database</li>
<li>Create vector tiles for web visualization (PMTiles format)</li>
</ol>
</section>
<section id="key-challenges-considerations" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="key-challenges-considerations"><span class="header-section-number">1.3</span> Key Challenges &amp; Considerations</h3>
<ul>
<li><strong>Data Volume</strong>: Processing 36 shapefiles with 334,092 data points per field</li>
<li><strong>Standardization</strong>: Ensuring consistent naming conventions across different data sources</li>
<li><strong>Performance</strong>: Optimizing tile generation for web visualization</li>
<li><strong>Maintainability</strong>: Creating reusable code for future data updates</li>
</ul>
</section>
</section>
<section id="data-processing-pipeline" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="data-processing-pipeline"><span class="header-section-number">2</span> Data Processing Pipeline</h2>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
    A[Raw Shapefiles&lt;br/&gt;36 files total] --&gt; B[Parse &amp; Extract Metadata]
    B --&gt; C[Extract Geometry&lt;br/&gt;FID-based]
    B --&gt; D[Transform to Long Format]
    D --&gt; E[Generate Layer Keys]
    E --&gt; F[Create Wide Format]
    F --&gt; G[Combine with Geometry]
    G --&gt; H[(PostgreSQL/PostGIS&lt;br/&gt;Database)]
    G --&gt; I[GeoJSON Export]
    I --&gt; J[MBTiles&lt;br/&gt;Vector Tiles]
    J --&gt; K[PMTiles&lt;br/&gt;Web-ready Format]
    K --&gt; L[S3 Cloud Storage]
    L --&gt; M[Web Visualization]
    
    style A fill:#f9f,stroke:#333,stroke-width:2px
    style H fill:#bbf,stroke:#333,stroke-width:2px
    style M fill:#bfb,stroke:#333,stroke-width:2px
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="environment-setup" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="environment-setup"><span class="header-section-number">3</span> Environment Setup</h2>
<section id="prerequisites" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="prerequisites"><span class="header-section-number">3.1</span> Prerequisites</h3>
<p>Before running this workflow, ensure you have the following system dependencies installed:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># macOS installation</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install tippecanoe  <span class="co"># For MBTiles generation</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install pmtiles     <span class="co"># For PMTiles conversion</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>TODO:</p>
<ul class="task-list">
<li><label><input type="checkbox">Add instructions for Linux and Windows installations</label></li>
<li><label><input type="checkbox">Add installation checks for required system dependencies</label></li>
<li><label><input type="checkbox">Consider containerizing these dependencies for reproducibility</label></li>
</ul>
</section>
<section id="load-required-libraries-and-configure-paths" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="load-required-libraries-and-configure-paths"><span class="header-section-number">3.2</span> Load Required Libraries and Configure Paths</h3>
<p>This section loads all necessary R packages and sets up file paths for data processing. The workflow uses a combination of spatial data processing (<code>sf</code>), database connectivity (<code>DBI</code>, <code>RPostgres</code>), and data manipulation (<code>dplyr</code>, <code>tidyr</code>) packages.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  DBI, dplyr, DT, fs, glue, here, janitor, mapgl,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  sf, tidyr, purrr, readr, RPostgres, </span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  tibble, wdpar,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">readr.show_col_types =</span> F)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Determine environment and set paths accordingly</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>is_server   <span class="ot">&lt;-</span>  <span class="fu">Sys.info</span>()[[<span class="st">"sysname"</span>]] <span class="sc">==</span> <span class="st">"Linux"</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Consider using environment variables for these paths</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Add validation that all directories exist</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>dir_raw     <span class="ot">&lt;-</span> <span class="st">'~/My Drive/projects/oceanmetrics/data/raw/couto.thiagoba@gmail.com_indicators'</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>dir_shp     <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_raw}/Indicators_AllProducts_may2025/Shapefiles"</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Output file paths</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>fid_geo     <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_raw}/fid.geojson"</span>)        <span class="co"># Geometry with FID identifiers</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>long_csv    <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_raw}/data_long.csv"</span>)      <span class="co"># Long format data</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>wide_csv    <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_raw}/data_wide.csv"</span>)      <span class="co"># Wide format data  </span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>lyr_csv     <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_raw}/layers.csv"</span>)         <span class="co"># Layer metadata</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>lyr_lu_csv  <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_raw}/layer_lookup.csv"</span>)   <span class="co"># Layer lookup table</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>data_geo    <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_raw}/indicators.geojson"</span>) <span class="co"># Combined GeoJSON</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>data_mbt    <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_raw}/indicators.mbtiles"</span>) <span class="co"># MBTiles output</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>data_pmt    <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_raw}/indicators.pmtiles"</span>) <span class="co"># PMTiles output</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Private credentials location</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>dir_private <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(is_server, <span class="st">"/share/private"</span>, <span class="st">"~/My Drive/private"</span>)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>db_pass_txt <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"{dir_private}/msens-db_admin-pass.txt"</span>)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Add directory existence checks</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="database-connection" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="database-connection"><span class="header-section-number">3.3</span> Database Connection</h3>
<p>Connect to the PostgreSQL/PostGIS database for storing processed indicator data. The connection uses environment-specific settings to support both development (local) and production (server) environments.</p>
<section id="security-note" class="level4">
<h4 class="anchored" data-anchor-id="security-note">Security Note</h4>
<p>Database credentials are stored in a separate file outside the repository for security. Ensure the password file exists at the specified location before running.</p>
<p>TODO:</p>
<ul class="task-list">
<li><label><input type="checkbox">Add connection error handling and retry logic</label></li>
<li><label><input type="checkbox">Consider using connection pooling for better performance</label></li>
<li><label><input type="checkbox">Add connection validation before proceeding with data operations</label></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">file.exists</span>(db_pass_txt))</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>con <span class="ot">&lt;-</span> DBI<span class="sc">::</span><span class="fu">dbConnect</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  RPostgres<span class="sc">::</span><span class="fu">Postgres</span>(),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">dbname   =</span> <span class="st">"msens"</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">host     =</span> <span class="fu">ifelse</span>(is_server, <span class="st">"postgis"</span>, <span class="st">"localhost"</span>),</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">port     =</span> <span class="dv">5432</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">user     =</span> <span class="st">"admin"</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">password =</span> <span class="fu">readLines</span>(db_pass_txt),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">options  =</span><span class="st">"-c search_path=oceanmetrics,public"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
</section>
<section id="data-transformation" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="data-transformation"><span class="header-section-number">4</span> Data Transformation</h2>
<section id="overview-of-transformation-process" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="overview-of-transformation-process"><span class="header-section-number">4.1</span> Overview of Transformation Process</h3>
<p>The data transformation involves several key steps:</p>
<ol type="1">
<li><strong>Metadata Extraction</strong>: Parse filenames to extract indicator type, season, and species group</li>
<li><strong>Geometry Standardization</strong>: Extract consistent FID-based geometries from all shapefiles</li>
<li><strong>Data Pivoting</strong>: Transform from wide to long format for better database normalization</li>
<li><strong>Key Generation</strong>: Create standardized layer keys for consistent referencing</li>
</ol>
</section>
<section id="parse-shapefiles-and-extract-metadata" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="parse-shapefiles-and-extract-metadata"><span class="header-section-number">4.2</span> Parse Shapefiles and Extract Metadata</h3>
<p>This section reads all shapefiles, extracts metadata from filenames, and prepares the data for transformation. The filename pattern follows: <code>{indicator}_{type}_{season}_{group}.shp</code></p>
</section>
<section id="extract-geometry-and-transform-to-long-format" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="extract-geometry-and-transform-to-long-format"><span class="header-section-number">4.3</span> Extract Geometry and Transform to Long Format</h3>
<p>This step extracts the spatial geometry from the shapefiles and transforms the attribute data into a long format suitable for database storage.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parse shapefile filenames to extract metadata components</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Filename pattern: {indicator}_{type}_{season}_{group}.shp</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Add validation for expected filename pattern</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Consider logging files that don't match expected pattern</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Add error handling for malformed shapefiles</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>d_shp <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">path =</span> <span class="fu">dir_ls</span>(dir_shp, <span class="at">glob =</span> <span class="st">'*.shp'</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">shp       =</span> <span class="fu">basename</span>(path),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">fname     =</span> <span class="fu">path_ext_remove</span>(shp),</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">data      =</span> <span class="fu">map</span>(path, <span class="sc">~</span> <span class="fu">st_read</span>(.x, <span class="at">quiet =</span> <span class="cn">TRUE</span>)),</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow      =</span> <span class="fu">map_int</span>(data, nrow),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">ncol      =</span> <span class="fu">map_int</span>(data, ncol),</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_cols =</span> <span class="fu">map</span>(data, names),</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">cols_chr  =</span> <span class="fu">map_chr</span>(data_cols, paste, <span class="at">collapse =</span> <span class="st">', '</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">separate</span>(</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    fname, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">'ind'</span>, <span class="st">'type'</span>, <span class="st">'season'</span>, <span class="st">'group'</span>),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">sep =</span> <span class="st">'_'</span>, <span class="at">remove =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>fname) <span class="sc">|&gt;</span> </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(shp, ind, type, season, group)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="co"># summaries ----</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="co"># table(d_shp$ind, d_shp$type)</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     CumulativeUncertainty RichShape WeightedRichShape</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Ind                    12        12                12</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a><span class="co"># table(d_shp$season, d_shp$group)</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a><span class="co">#        All Fish Ray Red-listed Shark Turtle</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a><span class="co"># summer   3    3   3          3     3      3</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a><span class="co"># winter   3    3   3          3     3      3</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="co"># table(d_shp$cols_chr)</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a><span class="co">#            FID, mx_mn_r, ecrg_rc, htspt_c, geometry </span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                  12 </span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a><span class="co">#                 FID, plt_dt_m_, plt_dt_s_, geometry </span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                  12 </span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a><span class="co"># FID, Uncrt_c, Uncrt_s, ecrg_ncr, ecrg_ncl, geometry </span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co">#                                                  12 </span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="co"># get the geometry from the first shapefile ----</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>d_geom <span class="ot">&lt;-</span> d_shp<span class="sc">$</span>data[[<span class="dv">1</span>]] <span class="sc">|&gt;</span> </span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">fid =</span> <span class="fu">as.integer</span>(FID)) <span class="sc">|&gt;</span> </span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(fid) <span class="sc">|&gt;</span> </span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_transform</span>(<span class="dv">4326</span>)</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file_exists</span>(fid_geo))</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file_delete</span>(fid_geo)</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="fu">write_sf</span>(d_geom, fid_geo)</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a><span class="co"># go long with data to relate by fid to geom  ----</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>d_long <span class="ot">&lt;-</span> d_shp <span class="sc">|&gt;</span> </span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(ind, type, season, group, data) <span class="sc">|&gt;</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> <span class="fu">map</span>(data, \(x){</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>      x <span class="sc">|&gt;</span> </span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">st_drop_geometry</span>() <span class="sc">|&gt;</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(<span class="fu">where</span>(<span class="sc">~</span> <span class="sc">!</span><span class="fu">is.character</span>(.))) <span class="sc">|&gt;</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># clean_names() |&gt;</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>        <span class="fu">pivot_longer</span>(</span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>          <span class="at">cols =</span> <span class="sc">-</span>FID,</span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>          <span class="at">names_to =</span> <span class="st">'field'</span>, <span class="at">values_to =</span> <span class="st">'value'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rename</span>(<span class="at">fid =</span> FID) } ) ) <span class="sc">|&gt;</span> </span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest</span>(data) <span class="sc">|&gt;</span> </span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">fid =</span> <span class="fu">as.integer</span>(fid)) <span class="sc">|&gt;</span> </span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(value))</span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_long, long_csv)</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a><span class="co"># table(d_data$field)</span></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a><span class="co"># ecrg_ncr  ecrg_rc  mx_mn_r plt_dt_m plt_dt_s  uncrt_c  uncrt_s </span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a><span class="co">#   334092   334092   334092   334092   334092   334092   334092</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="generate-layer-metadata-and-keys" class="level3" data-number="4.4">
<h3 data-number="4.4" class="anchored" data-anchor-id="generate-layer-metadata-and-keys"><span class="header-section-number">4.4</span> Generate Layer Metadata and Keys</h3>
<p>This step creates standardized layer identifiers and human-readable descriptions for each unique combination of species group, indicator type, season, and field.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># d_long &lt;- read_csv(long_csv)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>d_geom <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(fid_geo)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>d_lyrs <span class="ot">&lt;-</span> d_long <span class="sc">|&gt;</span> </span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(group, type, season, field) <span class="sc">|&gt;</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(group, type, season, field)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create lookup table with all unique values from each column</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>d_lyr_lu <span class="ot">&lt;-</span> d_lyrs <span class="sc">|&gt;</span> </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(group, type, season, field) <span class="sc">|&gt;</span> </span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="fu">everything</span>(), <span class="at">names_to =</span> <span class="st">"column"</span>, <span class="at">values_to =</span> <span class="st">"value"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>() <span class="sc">|&gt;</span> </span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(column, value) <span class="sc">|&gt;</span> </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">key         =</span> <span class="st">""</span>,</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">description =</span> <span class="st">""</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Write to CSV</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file_exists</span>(lyr_lu_csv))</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write_csv</span>(d_lyr_lu, lyr_lu_csv)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Edit the lookup table manually</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the populated lookup table</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>d_lyr_lu <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(lyr_lu_csv)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">sum</span>(<span class="fu">duplicated</span>(d_lyr_lu<span class="sc">$</span>key)) <span class="sc">==</span> <span class="dv">0</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to get key/description per column from lookup table</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>lu <span class="ot">&lt;-</span> <span class="cf">function</span>(val, <span class="at">desc_type =</span> <span class="st">"k"</span>, <span class="at">df_lookup =</span> d_lyr_lu) {</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  col      <span class="ot">&lt;-</span> <span class="fu">deparse</span>(<span class="fu">substitute</span>(val))</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  desc_col <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(desc_type <span class="sc">==</span> <span class="st">"k"</span>, <span class="st">"key"</span>, <span class="st">"description"</span>)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  df_lookup <span class="sc">|&gt;</span> </span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(column <span class="sc">==</span> <span class="sc">!!</span>col, value <span class="sc">==</span> <span class="sc">!!</span>val) <span class="sc">|&gt;</span> </span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pull</span>(<span class="sc">!!</span>desc_col)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate keys and descriptions for layers with lookup</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>d_lyrs <span class="ot">&lt;-</span> d_lyrs <span class="sc">|&gt;</span> </span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">|&gt;</span> </span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">key         =</span> <span class="fu">glue</span>(</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a>      <span class="co"># key: "{group}_{field}_{season}_{type}"</span></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>      <span class="st">"{lu(group, 'k')}_{lu(field, 'k')}_{lu(season, 'k')}_{lu(type, 'k')}"</span>),</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">description =</span> <span class="fu">glue</span>(</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>      <span class="co"># deescription: "{group} {field} in {season} for {type}"</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>      <span class="st">"{lu(group, 'd')} {lu(field, 'd')} in {lu(season, 'd')} for {lu(type, 'd')}"</span>) ) <span class="sc">|&gt;</span> </span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">|&gt;</span> </span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(key, group, field, season, type, description)</span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Append value_min and value_max columns to d_lyrs per layer key from d_long ----</span></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>d_lyrs <span class="ot">&lt;-</span> d_lyrs <span class="sc">|&gt;</span> </span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    d_long <span class="sc">|&gt;</span> </span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>      <span class="fu">group_by</span>(group, field, season, type) <span class="sc">|&gt;</span> </span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>      <span class="fu">summarise</span>(</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">value_min =</span> <span class="fu">min</span>(value, <span class="at">na.rm =</span> T),</span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">value_max =</span> <span class="fu">max</span>(value, <span class="at">na.rm =</span> T),</span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">.groups =</span> <span class="st">"drop"</span>),</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(group, type, season, field) )</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_lyrs, lyr_csv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="transform-to-wide-format" class="level3" data-number="4.5">
<h3 data-number="4.5" class="anchored" data-anchor-id="transform-to-wide-format"><span class="header-section-number">4.5</span> Transform to Wide Format</h3>
<p>This step pivots the long format data back to a wide format where each layer becomes a column, making it suitable for GIS applications and web visualization.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Join long data with layer keys and descriptions ----</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>d_wide <span class="ot">&lt;-</span> d_long <span class="sc">|&gt;</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    d_lyrs <span class="sc">|&gt;</span> </span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(key, group, type, season, field), </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">join_by</span>(group, type, season, field)) <span class="sc">|&gt;</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(fid, key, value) <span class="sc">|&gt;</span> </span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from  =</span> key,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> value)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="fu">write_csv</span>(d_wide, wide_csv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="combine-data-with-geometry" class="level3" data-number="4.6">
<h3 data-number="4.6" class="anchored" data-anchor-id="combine-data-with-geometry"><span class="header-section-number">4.6</span> Combine Data with Geometry</h3>
<p>This step merges the transformed attribute data with the spatial geometry to create the final spatial dataset.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># combine wide data and fid geometry ----</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>d_indicators <span class="ot">&lt;-</span> d_wide <span class="sc">|&gt;</span> </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    d_geom, <span class="at">by =</span> <span class="fu">join_by</span>(fid)) <span class="sc">|&gt;</span> </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(fid) <span class="sc">|&gt;</span> </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">st_as_sf</span>()</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="fu">st_geometry</span>(d_indicators) <span class="ot">&lt;-</span> <span class="st">"geom"</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># mapview::mapView(d_indicators)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="store-in-postgresqlpostgis-database" class="level3" data-number="4.7">
<h3 data-number="4.7" class="anchored" data-anchor-id="store-in-postgresqlpostgis-database"><span class="header-section-number">4.7</span> Store in PostgreSQL/PostGIS Database</h3>
<p>This final transformation step writes the processed data to the PostgreSQL database with proper spatial indexing and primary key constraints.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># write to database ----</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Add transaction support for atomic writes</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Add validation of successful write before proceeding</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># </span><span class="al">TODO</span><span class="co">: Consider adding spatial indexes for better query performance</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>schema <span class="ot">&lt;-</span> <span class="st">"oceanmetrics"</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>tbl    <span class="ot">&lt;-</span> <span class="st">"ds_indicators"</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dbExistsTable</span>(con, <span class="fu">Id</span>(<span class="at">schema =</span> schema, <span class="at">table =</span> tbl))) {</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  d_indicators <span class="sc">|&gt;</span> </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">as.integer</span>(fid)) <span class="sc">|&gt;</span> </span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>fid) <span class="sc">|&gt;</span> </span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">st_write</span>(con, tbl)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="co"># enforce SRID so shows up in tile.marinesensivity.org</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT UpdateGeometrySRID('{schema}','{tbl}','geom',4326);"</span>))</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># make id the primary key</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbExecute</span>(con, <span class="fu">glue</span>(</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"ALTER TABLE {schema}.{tbl} ADD PRIMARY KEY (id);"</span>))</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dbWriteTable</span>(con, <span class="st">"ds_indicators_lyrs"</span>, d_lyrs, <span class="at">row.names =</span> F, <span class="at">overwrite =</span> T)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="visualize-with-mapgl" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="visualize-with-mapgl"><span class="header-section-number">5</span> Visualize with <code>mapgl</code></h2>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>ply_url     <span class="ot">&lt;-</span> <span class="st">"https://api.marinesensitivity.org/tilejson?table=oceanmetrics.ds_indicators"</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>key         <span class="ot">&lt;-</span> <span class="st">"al_er_su_wr"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>description <span class="ot">&lt;-</span> d_lyrs <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(key <span class="sc">==</span> <span class="sc">!!</span>key) <span class="sc">|&gt;</span> </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(description)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>n_cols <span class="ot">&lt;-</span> <span class="dv">11</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>cols <span class="ot">&lt;-</span> <span class="fu">rev</span>(RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(n_cols, <span class="st">"Spectral"</span>))</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>brks <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fl">1.0</span>, <span class="at">length.out =</span> n_cols)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="co"># mapboxgl(</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="co">#   style      = mapbox_style("dark"),</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="fu">maplibre</span>(</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">style      =</span> <span class="fu">carto_style</span>(<span class="st">"voyager"</span>),</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">projection =</span> <span class="st">"globe"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit_bounds</span>(d_geom, <span class="at">animate =</span> F) <span class="sc">|&gt;</span> </span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_vector_source</span>(</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">id         =</span> <span class="st">"src"</span>,</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">url        =</span> ply_url,</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">promoteId  =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_fill_layer</span>(</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">id            =</span> <span class="st">"ply"</span>,</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">source        =</span> <span class="st">"src"</span>,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">source_layer  =</span> <span class="st">"oceanmetrics.ds_indicators"</span>,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill_color    =</span> <span class="fu">interpolate</span>(</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">column =</span> key,</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>      <span class="at">values =</span> brks,</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">stops  =</span> cols ),</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill_opacity  =</span> <span class="fl">0.7</span>,</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">tooltip       =</span> key,</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">popup         =</span> <span class="fu">concat</span>(</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>      <span class="st">"layer column: "</span>, key, <span class="st">"&lt;/pre&gt;&lt;br&gt;</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="st">       feature id: "</span>, <span class="fu">get_column</span>(<span class="st">"id"</span>), <span class="st">"&lt;/pre&gt;&lt;br&gt;</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="st">       value: "</span>, <span class="fu">get_column</span>(key) ),</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">hover_options =</span> <span class="fu">list</span>(</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill_color   =</span> <span class="st">"cyan"</span>,</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill_opacity =</span> <span class="dv">1</span> ) ) <span class="sc">|&gt;</span> </span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_legend</span>(</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>    description,</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">values   =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">colors   =</span> cols,</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"bottom-right"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_fullscreen_control</span>(</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">position =</span> <span class="st">"top-left"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_navigation_control</span>() <span class="sc">|&gt;</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_scale_control</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="htmlwidget-0c8fb511a9973914c8df" style="width:100%;height:480px;" class="maplibregl html-widget"></div>
<script type="application/json" data-for="htmlwidget-0c8fb511a9973914c8df">{"x":{"style":"https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json","center":[0,0],"zoom":0,"bearing":0,"pitch":0,"additional_params":{"projection":"globe"},"fitBounds":{"bounds":[-97.8662821205578,11.76369271873196,-43.88874615326504,56.52493598194877],"options":{"animate":false}},"sources":[{"id":"src","type":"vector","url":"https://api.marinesensitivity.org/tilejson?table=oceanmetrics.ds_indicators","promoteId":"id"}],"layers":[{"id":"ply","type":"fill","source":"src","source_layer":"oceanmetrics.ds_indicators","paint":{"fill-antialias":true,"fill-color":["interpolate",["linear"],["get","al_er_su_wr"],0,"#5E4FA2",0.1,"#3288BD",0.2,"#66C2A5",0.3,"#ABDDA4",0.4,"#E6F598",0.5,"#FFFFBF",0.6000000000000001,"#FEE08B",0.7000000000000001,"#FDAE61",0.8,"#F46D43",0.9,"#D53E4F",1,"#9E0142"],"fill-opacity":0.7,"fill-translate-anchor":"map"},"layout":{"visibility":"visible"},"slot":null,"minzoom":null,"maxzoom":null,"popup":["concat","layer column: ","al_er_su_wr","<\/pre><br>\n       feature id: ",["get","id"],"<\/pre><br>\n       value: ",["get","al_er_su_wr"]],"tooltip":"al_er_su_wr","hover_options":{"fill_color":"cyan","fill_opacity":1},"before_id":null,"filter":null}],"legend_html":"<div id=\"legend-c20c3\" class=\"mapboxgl-legend bottom-right\"><h2>All Ecoregion-weighted richness in summer for WeightedRichShape<\/h2><div class=\"legend-gradient\" style=\"background:linear-gradient(to right, #5E4FA2, #3288BD, #66C2A5, #ABDDA4, #E6F598, #FFFFBF, #FEE08B, #FDAE61, #F46D43, #D53E4F, #9E0142)\"><\/div><div class=\"legend-labels\" style=\"position: relative; height: 20px;\"><div class=\"legend-labels\"><span style=\"position: absolute; left: 0%;\">0<\/span><span style=\"position: absolute; left: 100%;\">1<\/span><\/div><\/div><\/div>","legend_css":"\n    @import url('https://fonts.googleapis.com/css2?family=Open+Sans&display=swap');\n\n    #legend-c20c3 h2 {\n      font-size: 14px;\n      font-family: 'Open Sans';\n      line-height: 20px;\n      margin-bottom: 10px;\n      margin-top: 0px;\n    }\n\n    #legend-c20c3 {\n      position: absolute;\n      border-radius: 10px;\n      margin: 10px;\n      width: 200px;\n      background-color: #ffffff80;\n      padding: 10px 20px;\n      z-index: 1002;\n    }\n\n    #legend-c20c3.top-left {\n      top: 10px;\n      left: 10px;\n    }\n\n    #legend-c20c3.bottom-left {\n      bottom: 10px;\n      left: 10px;\n    }\n\n    #legend-c20c3.top-right {\n      top: 10px;\n      right: 10px;\n    }\n\n    #legend-c20c3.bottom-right {\n      bottom: 10px;\n      right: 10px;\n    }\n\n    #legend-c20c3 .legend-gradient {\n      height: 20px;\n      margin: 5px 10px 5px 10px;\n    }\n\n    #legend-c20c3 .legend-labels {\n      position: relative;\n      height: 20px;\n      margin: 0 10px;\n    }\n\n    #legend-c20c3 .legend-labels span {\n      font-size: 12px;\n      position: absolute;\n      transform: translateX(-50%);  /* Center all labels by default */\n      white-space: nowrap;\n    }\n\n","fullscreen_control":{"enabled":true,"position":"top-left"},"navigation_control":{"show_compass":true,"show_zoom":true,"visualize_pitch":false,"position":"top-right","orientation":"vertical"},"scale_control":{"position":"bottom-left","unit":"metric","maxWidth":100}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
</section>
<section id="vector-tile-generation-archived" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="vector-tile-generation-archived"><span class="header-section-number">6</span> Vector Tile Generation (Archived)</h2>
<p><strong>Note</strong>: This section contains archived code for generating vector tiles. Consider updating to use the database directly for tile generation.</p>
<section id="background-on-vector-tiles" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="background-on-vector-tiles"><span class="header-section-number">6.1</span> Background on Vector Tiles</h3>
<p>Vector tiles are an efficient way to serve spatial data for web visualization:</p>
<ul>
<li><strong>MBTiles</strong>: SQLite-based format for storing tiled map data</li>
<li><strong>PMTiles</strong>: Cloud-optimized format that can be served directly from S3</li>
<li><strong>Tippecanoe</strong>: Tool for creating vector tiles with intelligent simplification</li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stop eval for now</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">eval =</span> F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tippecanoe(</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">#   glue("'{normalizePath(data_geo)}'"),</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">#   basename(data_mbt),</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">#   layer_name   = "indicators",</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">#   keep_geojson = T)</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># tippecanoe v2.78.0</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 27841 features, 20167849 bytes of geometry and attributes, 17959145 bytes of string pool, 0 bytes of vertices, 0 bytes of nodes</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Choosing a maxzoom of -z2 for features typically 37540 feet (11443 meters) apart, and at least 18667 feet (5690 meters) apart</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Choosing a maxzoom of -z8 for resolution of about 1507 feet (459 meters) within features</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co"># tile 0/0/0 size is 4854382 with detail 12, &gt;500000    </span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Going to try keeping the sparsest 8.24% of the features to make it fit</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># https://github.com/mapbox/tippecanoe?tab=readme-ov-file#continuous-polygon-features-states-and-provinces-visible-at-all-zoom-levels</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co"># -zg: Automatically choose a maxzoom that should be sufficient to clearly distinguish the features and the detail within each feature</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co"># --coalesce-densest-as-needed: If the tiles are too big at low or medium zoom levels, merge as many features together as are necessary to allow tiles to be created with those features that are still distinguished</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co">#</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co"># --extend-zooms-if-still-dropping: If even the tiles at high zoom levels are too big, keep adding zoom levels until one is reached that can represent all the features</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="co"># system(glue("</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="co">#   tippecanoe -o {basename(data_mbt)}  \\</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co">#     --maximum-tile-bytes=1000000      \\</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="co">#     --simplification=10               \\</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a><span class="co">#     -zg                               \\</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="co">#     --coalesce-densest-as-needed      \\</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a><span class="co">#     --extend-zooms-if-still-dropping  \\</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a><span class="co">#     --force                           \\</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co">#     '{normalizePath(data_geo)}' " )</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="co"># )</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>cmd <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a><span class="st">  tippecanoe -o {basename(data_mbt)}  </span><span class="sc">\\</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="st">    --maximum-tile-bytes=1000000      </span><span class="sc">\\</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a><span class="st">    --simplification=10               </span><span class="sc">\\</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="st">    -zg                               </span><span class="sc">\\</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a><span class="st">    --coalesce-densest-as-needed      </span><span class="sc">\\</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a><span class="st">    --extend-zooms-if-still-dropping  </span><span class="sc">\\</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a><span class="st">    --force                           </span><span class="sc">\\</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="st">    '{normalizePath(data_geo)}' "</span> )</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(cmd)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(cmd)</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a><span class="co"># -zg: Automatically choose a maxzoom that should be sufficient to clearly distinguish the features and the detail within each feature</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file_exists</span>(data_mbt))</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file_delete</span>(data_mbt)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a><span class="fu">file_move</span>(</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">basename</span>(data_mbt),</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>  data_mbt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">file_exists</span>(data_pmt))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">file_delete</span>(data_pmt)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(<span class="fu">glue</span>(<span class="st">"</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="st">  pmtiles convert </span><span class="sc">\\</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="st">    '{normalizePath(data_mbt)}' </span><span class="sc">\\</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="st">    '{normalizePath(data_pmt, mustWork=F)}' "</span> ) )</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2025/06/05 16:32:37 convert.go:159: Pass 1: Assembling TileID set</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 2025/06/05 16:32:37 convert.go:190: Pass 2: writing tiles</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="co">#  100% || (508/508, 1333 it/s)        </span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 2025/06/05 16:32:38 convert.go:244: # of addressed tiles:  508</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 2025/06/05 16:32:38 convert.go:245: # of tile entries (after RLE):  508</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 2025/06/05 16:32:38 convert.go:246: # of tile contents:  508</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 2025/06/05 16:32:38 convert.go:269: Total dir bytes:  1621</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 2025/06/05 16:32:38 convert.go:270: Average bytes per addressed tile: 3.19</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 2025/06/05 16:32:38 convert.go:239: Finished in  460.858875ms</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># [setup s3 bucket](https://oceanmetrics.github.io/workflows/explore_geoarrow.html#setup-s3-aws-bucket)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>d_aws <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">'~/My Drive/private/ben_ben@ecoquants.com_console.aws.amazon.com_accessKeys.csv'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_names</span>()</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">Sys.setenv</span>(</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"AWS_ACCESS_KEY_ID"</span>     <span class="ot">=</span> d_aws<span class="sc">$</span>access_key_id,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"AWS_SECRET_ACCESS_KEY"</span> <span class="ot">=</span> d_aws<span class="sc">$</span>secret_access_key,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"AWS_DEFAULT_REGION"</span>    <span class="ot">=</span> <span class="st">"us-east-1"</span>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>bucket <span class="ot">&lt;-</span> <span class="st">"oceanmetrics.io-public"</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co"># load/reload aws.s3 to read credentials</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co"># unloadNamespace("mapboxapi")</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="fu">unloadNamespace</span>(<span class="st">"aws.s3"</span>)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>  aws.s3,</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">quiet =</span> T)</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co"># bucketlist()</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="fu">stopifnot</span>(<span class="fu">bucket_exists</span>(bucket))</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>o      <span class="ot">&lt;-</span> <span class="fu">basename</span>(data_pmt)</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>o_file <span class="ot">&lt;-</span> data_pmt</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">object_exists</span>(o, bucket))</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">put_object</span>(o_file, o, bucket, <span class="at">multipart =</span> T, <span class="at">verbose =</span> F)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="co"># put_acl(o, bucket, acl = "public-read")</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="co"># "The bucket does not allow ACLs"</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co"># check</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>o_s3 <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"s3://{bucket}/{o}"</span>)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="fu">object_exists</span>(o_s3)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co"># s3://oceanmetrics.io-public/indicators.pmtiles</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>url_s3 <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"https://s3.us-east-1.amazonaws.com/{bucket}/{o}"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>url_pmview <span class="ot">&lt;-</span> <span class="fu">glue</span>(<span class="st">"https://pmtiles.io/#url={url_s3}"</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="fu">browseURL</span>(url_pmview)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="additional-data-sources" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="additional-data-sources"><span class="header-section-number">7</span> Additional Data Sources</h2>
<section id="world-database-on-protected-areas-wdpa" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="world-database-on-protected-areas-wdpa"><span class="header-section-number">7.1</span> World Database on Protected Areas (WDPA)</h3>
<p>This section demonstrates how to integrate additional protected area data from WDPA, which could be overlaid with the biodiversity indicators.</p>
<p><strong>TODO</strong>: This section needs to be integrated with the main workflow or moved to a separate document.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># rappdirs::user_data_dir("wdpar")</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>dir_wdpar <span class="ot">&lt;-</span> <span class="st">"~/My Drive/projects/oceanmetrics/data/raw/wdpar"</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># download protected area data for Malta</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>pa <span class="ot">&lt;-</span> <span class="fu">wdpa_fetch</span>(</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"global"</span>, <span class="at">wait =</span> <span class="cn">TRUE</span>, <span class="at">download_dir =</span> dir_wdpar)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Warning message:</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># In CPL_read_ogr(dsn, layer, query, as.character(options), quiet,  :</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">#   GDAL Message 1: organizePolygons() received a polygon with more than 100 parts. The processing may be really slow.  You can skip the processing by setting METHOD=SKIP, or only make it analyze counter-clock wise parts by setting METHOD=ONLY_CCW if you can assume that the outline of holes is counter-clock wise defined</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co"># clean protected area data (with procedure for erasing overlaps disabled)</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>pa_cl <span class="ot">&lt;-</span> <span class="fu">wdpa_clean</span>(pa, <span class="at">erase_overlaps =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The <code>echo: false</code> option disables the printing of code (only output is displayed).</p>
<p>TODO: add PMTiles from <a href="https://map.navigatormap.org/">ProtectedSeas Navigator</a>:</p>
<ul>
<li><a href="https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/eez.pmtiles" class="uri">https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/eez.pmtiles</a></li>
<li><a href="https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/12nm.pmtiles" class="uri">https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/12nm.pmtiles</a></li>
<li><a href="https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp3_fill.pmtiles" class="uri">https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp3_fill.pmtiles</a></li>
<li><a href="https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp4_fill.pmtiles" class="uri">https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp4_fill.pmtiles</a></li>
<li><a href="https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp5_fill.pmtiles" class="uri">https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp5_fill.pmtiles</a></li>
<li><a href="https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp1_boundaries.pmtiles" class="uri">https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp1_boundaries.pmtiles</a></li>
<li><a href="https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp2_boundaries.pmtiles" class="uri">https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp2_boundaries.pmtiles</a></li>
<li><a href="https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp3_boundaries.pmtiles" class="uri">https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp3_boundaries.pmtiles</a></li>
<li><a href="https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp4_boundaries.pmtiles" class="uri">https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp4_boundaries.pmtiles</a></li>
<li><a href="https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp5_boundaries.pmtiles" class="uri">https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp5_boundaries.pmtiles</a></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  glue, sf)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp3_fill.pmtiles"</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(<span class="fu">glue</span>(<span class="st">"pmtiles show '{url}'"</span>))</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>lfp3 <span class="ot">&lt;-</span> <span class="fu">st_read</span>(url)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leafem)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co"># url = "https://vector-tiles-data.s3.eu-central-1.amazonaws.com/rivers_africa.pmtiles"</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPMPolylines</span>(</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">url =</span> url</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    , <span class="at">layerId =</span> <span class="st">"rivers"</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    , <span class="at">group =</span> <span class="st">"rivers"</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    , <span class="at">style =</span> <span class="fu">paintRules</span>(</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">layer =</span> <span class="st">"rivers_africa"</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">"blue"</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setView</span>(<span class="dv">24</span>, <span class="fl">2.5</span>, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p><a href="https://pmtiles.io/#url=https%3A%2F%2Fs3.us-west-2.amazonaws.com%2Fpmtiles.navigator.protectedseas%2Flfp3_fill.pmtiles" class="uri">https://pmtiles.io/#url=https%3A%2F%2Fs3.us-west-2.amazonaws.com%2Fpmtiles.navigator.protectedseas%2Flfp3_fill.pmtiles</a></p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>pm_viewer <span class="ot">&lt;-</span> <span class="st">"https://pmtiles.io/#url=https%3A%2F%2Fs3.us-west-2.amazonaws.com%2Fpmtiles.navigator.protectedseas%2Flfp3_fill.pmtiles"</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">URLdecode</span>(pm_viewer)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="st">"https://pmtiles.io/#url=https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp3_fill.pmtiles"</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github("walkerke/mapgl")</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  mapgl)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># pmtiles &lt;- "https://data.source.coop/cboettig/us-boundaries/mappinginequality.pmtiles"</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># lyr &lt;- "mappinginequality"</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>pmtiles <span class="ot">&lt;-</span> <span class="st">"https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp3_fill.pmtiles"</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>lyr <span class="ot">&lt;-</span> <span class="st">"lfp3_fill"</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>pmtiles <span class="ot">&lt;-</span> url_s3</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>lyr <span class="ot">&lt;-</span> <span class="st">"indicators"</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co"># lfp3_fill Polygon</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co"># missing ID</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co"># id    668</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co"># lfp   3</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co"># last_update   2025-04-30</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co"># region_type   eez</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="co"># mappinginequality Polygon</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="co"># missing ID</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="co"># area_id   3549</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="co"># city  New Haven</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="co"># state CT</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="co"># city_survey   true</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="co"># category  Still Desirable</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="co"># grade B</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="co"># label B5</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="co"># residential   true</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="co"># commercial    false</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="co"># industrial    false</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="co"># fill  #7cb5bd</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="co"># m &lt;-</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="fu">maplibre</span>(<span class="at">center=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">72.9</span>, <span class="fl">41.3</span>), <span class="at">zoom=</span><span class="dv">10</span>, <span class="at">height=</span><span class="st">"400"</span>) <span class="sc">|&gt;</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a><span class="co"># mapboxgl(center=c(-72.9, 41.3), zoom=10, height="400") |&gt;</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_vector_source</span>(</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pmtile_source"</span>,</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">url =</span> <span class="fu">paste0</span>(<span class="st">"pmtiles://"</span>, pmtiles) ) <span class="sc">|&gt;</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_fill_layer</span>(</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">id           =</span> <span class="st">"pmtile_layer"</span>,</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">source       =</span> <span class="st">"pmtile_source"</span>,</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># source_layer = "mappinginequality",</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># source_layer = "lfp3_fill",</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">source_layer =</span> <span class="st">"indicators"</span>,</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tooltip      = "grade",</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tooltip      = "id",</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">tooltip      =</span> <span class="st">"FID"</span>,</span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>    <span class="co"># filter       = list(</span></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   "==", </span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   list("get", "city"), "New Haven"),</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fill_color = list("get", "fill") </span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill_color =</span> <span class="st">"#0000FF80"</span>)</span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a><span class="co"># m</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="todo-lists-and-recommendations" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="todo-lists-and-recommendations"><span class="header-section-number">8</span> TODO Lists and Recommendations</h2>
<section id="high-priority-tasks" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="high-priority-tasks"><span class="header-section-number">8.1</span> High Priority Tasks</h3>
<ol type="1">
<li><strong>Error Handling &amp; Validation</strong>
<ul class="task-list">
<li><label><input type="checkbox">Add comprehensive error handling for file operations</label></li>
<li><label><input type="checkbox">Validate shapefile naming patterns before processing</label></li>
<li><label><input type="checkbox">Add transaction support for database writes</label></li>
<li><label><input type="checkbox">Implement rollback mechanisms for failed operations</label></li>
<li><label><input type="checkbox">Add checkpoints to resume processing after failures</label></li>
</ul></li>
<li><strong>Performance Optimization</strong>
<ul class="task-list">
<li><label><input type="checkbox">Consider parallel processing for shapefile reading</label></li>
<li><label><input type="checkbox">Add progress indicators for long-running operations</label></li>
<li><label><input type="checkbox">Implement chunked processing for large datasets</label></li>
<li><label><input type="checkbox">Add spatial indexes to database tables</label></li>
<li><label><input type="checkbox">Optimize tippecanoe parameters for tile generation</label></li>
</ul></li>
<li><strong>Configuration Management</strong>
<ul class="task-list">
<li><label><input type="checkbox">Move hardcoded paths to configuration file</label></li>
<li><label><input type="checkbox">Use environment variables for sensitive data</label></li>
<li><label><input type="checkbox">Create separate configs for dev/staging/production</label></li>
<li><label><input type="checkbox">Add configuration validation at startup</label></li>
</ul></li>
</ol>
</section>
<section id="medium-priority-tasks" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="medium-priority-tasks"><span class="header-section-number">8.2</span> Medium Priority Tasks</h3>
<ol start="4" type="1">
<li><strong>Documentation &amp; Logging</strong>
<ul class="task-list">
<li><label><input type="checkbox">Add detailed logging throughout the workflow</label></li>
<li><label><input type="checkbox">Create data dictionary for all fields</label></li>
<li><label><input type="checkbox">Document expected data formats and constraints</label></li>
<li><label><input type="checkbox">Add examples of input/output data</label></li>
<li><label><input type="checkbox">Create troubleshooting guide</label></li>
</ul></li>
<li><strong>Testing &amp; Quality Assurance</strong>
<ul class="task-list">
<li><label><input type="checkbox">Add unit tests for key functions</label></li>
<li><label><input type="checkbox">Create validation scripts for output data</label></li>
<li><label><input type="checkbox">Implement data quality checks</label></li>
<li><label><input type="checkbox">Add integration tests for full workflow</label></li>
<li><label><input type="checkbox">Create sample test datasets</label></li>
</ul></li>
<li><strong>Deployment &amp; Operations</strong>
<ul class="task-list">
<li><label><input type="checkbox">Containerize the workflow (Docker/Singularity)</label></li>
<li><label><input type="checkbox">Create automated deployment scripts</label></li>
<li><label><input type="checkbox">Add monitoring and alerting</label></li>
<li><label><input type="checkbox">Implement backup strategies</label></li>
<li><label><input type="checkbox">Create recovery procedures</label></li>
</ul></li>
</ol>
</section>
<section id="low-priority-enhancements" class="level3" data-number="8.3">
<h3 data-number="8.3" class="anchored" data-anchor-id="low-priority-enhancements"><span class="header-section-number">8.3</span> Low Priority Enhancements</h3>
<ol start="7" type="1">
<li><strong>Feature Additions</strong>
<ul class="task-list">
<li><label><input type="checkbox">Add support for additional file formats (GeoPackage, etc.)</label></li>
<li><label><input type="checkbox">Implement data versioning</label></li>
<li><label><input type="checkbox">Add metadata tracking (processing date, source version)</label></li>
<li><label><input type="checkbox">Create data validation reports</label></li>
<li><label><input type="checkbox">Add support for incremental updates</label></li>
</ul></li>
<li><strong>User Interface</strong>
<ul class="task-list">
<li><label><input type="checkbox">Create web interface for workflow monitoring</label></li>
<li><label><input type="checkbox">Add visualization of processing status</label></li>
<li><label><input type="checkbox">Implement notification system</label></li>
<li><label><input type="checkbox">Create admin dashboard</label></li>
</ul></li>
</ol>
</section>
</section>
<section id="key-questions-for-stakeholders" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="key-questions-for-stakeholders"><span class="header-section-number">9</span> Key Questions for Stakeholders</h2>
<section id="data-management" class="level3" data-number="9.1">
<h3 data-number="9.1" class="anchored" data-anchor-id="data-management"><span class="header-section-number">9.1</span> Data Management</h3>
<ol type="1">
<li><strong>Update Frequency</strong>: How often will new indicator data be available? Should we implement automated updates?</li>
<li><strong>Data Retention</strong>: What is the retention policy for historical data? Should we maintain versions?</li>
<li><strong>Access Control</strong>: Who should have access to raw vs.&nbsp;processed data?</li>
</ol>
</section>
<section id="technical-architecture" class="level3" data-number="9.2">
<h3 data-number="9.2" class="anchored" data-anchor-id="technical-architecture"><span class="header-section-number">9.2</span> Technical Architecture</h3>
<ol start="4" type="1">
<li><strong>Scalability</strong>: What is the expected data growth over the next 2-5 years?</li>
<li><strong>Performance Requirements</strong>: What are acceptable processing times for the full workflow?</li>
<li><strong>Integration</strong>: What other systems need to consume this data?</li>
</ol>
</section>
<section id="quality-validation" class="level3" data-number="9.3">
<h3 data-number="9.3" class="anchored" data-anchor-id="quality-validation"><span class="header-section-number">9.3</span> Quality &amp; Validation</h3>
<ol start="7" type="1">
<li><strong>Data Quality</strong>: What validation rules should be enforced on input data?</li>
<li><strong>Missing Data</strong>: How should we handle missing or incomplete datasets?</li>
<li><strong>Error Thresholds</strong>: What percentage of errors is acceptable before halting processing?</li>
</ol>
</section>
<section id="visualization-access" class="level3" data-number="9.4">
<h3 data-number="9.4" class="anchored" data-anchor-id="visualization-access"><span class="header-section-number">9.4</span> Visualization &amp; Access</h3>
<ol start="10" type="1">
<li><strong>Tile Strategy</strong>: Should we pre-generate all zoom levels or use dynamic tiling?</li>
<li><strong>Data Formats</strong>: Besides PMTiles, what other output formats are needed?</li>
<li><strong>API Requirements</strong>: Do we need a REST API for programmatic data access?</li>
</ol>
</section>
</section>
<section id="notes-on-current-implementation" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="notes-on-current-implementation"><span class="header-section-number">10</span> Notes on Current Implementation</h2>
<section id="strengths" class="level3" data-number="10.1">
<h3 data-number="10.1" class="anchored" data-anchor-id="strengths"><span class="header-section-number">10.1</span> Strengths</h3>
<ul>
<li>Clear separation of transformation steps</li>
<li>Good use of functional programming patterns</li>
<li>Efficient data pivoting strategies</li>
<li>Proper spatial data handling</li>
</ul>
</section>
<section id="areas-for-improvement" class="level3" data-number="10.2">
<h3 data-number="10.2" class="anchored" data-anchor-id="areas-for-improvement"><span class="header-section-number">10.2</span> Areas for Improvement</h3>
<ul>
<li>Limited error handling throughout</li>
<li>No progress indication for long operations</li>
<li>Hardcoded configuration values</li>
<li>Missing data validation steps</li>
<li>No automated testing framework</li>
</ul>
</section>
<section id="recommendations-for-next-steps" class="level3" data-number="10.3">
<h3 data-number="10.3" class="anchored" data-anchor-id="recommendations-for-next-steps"><span class="header-section-number">10.3</span> Recommendations for Next Steps</h3>
<ol type="1">
<li>Start with implementing error handling and validation</li>
<li>Create a configuration management system</li>
<li>Add comprehensive logging</li>
<li>Develop automated tests</li>
<li>Document all data transformations</li>
</ol>
<!-- -->

</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb18" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Ocean Metrics Indicators Data Ingestion Workflow"</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Ocean Metrics Team"</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="an">date:</span><span class="co"> today</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc-expand: 1    </span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="fu">## Overview</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>This workflow processes marine biodiversity indicator data from shapefiles into a structured format suitable for database storage and web visualization. The data includes various marine species groups (fish, sharks, rays, turtles) with seasonal variations and multiple indicator types.</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data Source</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>The input data consists of shapefiles containing:</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Species Groups**: Fish, Sharks, Rays, Red-listed species, Turtles, and All species combined</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Temporal Coverage**: Summer and Winter seasons</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Indicator Types**: </span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Cumulative Uncertainty</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Rich Shape (species richness)</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>Weighted Rich Shape (weighted species richness)</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="fu">### Workflow Goals</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Parse and standardize shapefile data from multiple files</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Transform data into a normalized long format</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Generate layer metadata with human-readable keys and descriptions</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Store processed data in PostgreSQL/PostGIS database</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Create vector tiles for web visualization (PMTiles format)</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key Challenges &amp; Considerations</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Data Volume**: Processing 36 shapefiles with 334,092 data points per field</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Standardization**: Ensuring consistent naming conventions across different data sources</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Performance**: Optimizing tile generation for web visualization</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Maintainability**: Creating reusable code for future data updates</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Processing Pipeline</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="in">```{mermaid}</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="in">flowchart TD</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a><span class="in">    A[Raw Shapefiles&lt;br/&gt;36 files total] --&gt; B[Parse &amp; Extract Metadata]</span></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="in">    B --&gt; C[Extract Geometry&lt;br/&gt;FID-based]</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a><span class="in">    B --&gt; D[Transform to Long Format]</span></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a><span class="in">    D --&gt; E[Generate Layer Keys]</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="in">    E --&gt; F[Create Wide Format]</span></span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a><span class="in">    F --&gt; G[Combine with Geometry]</span></span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a><span class="in">    G --&gt; H[(PostgreSQL/PostGIS&lt;br/&gt;Database)]</span></span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="in">    G --&gt; I[GeoJSON Export]</span></span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a><span class="in">    I --&gt; J[MBTiles&lt;br/&gt;Vector Tiles]</span></span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a><span class="in">    J --&gt; K[PMTiles&lt;br/&gt;Web-ready Format]</span></span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a><span class="in">    K --&gt; L[S3 Cloud Storage]</span></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a><span class="in">    L --&gt; M[Web Visualization]</span></span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a><span class="in">    </span></span>
<span id="cb18-60"><a href="#cb18-60" aria-hidden="true" tabindex="-1"></a><span class="in">    style A fill:#f9f,stroke:#333,stroke-width:2px</span></span>
<span id="cb18-61"><a href="#cb18-61" aria-hidden="true" tabindex="-1"></a><span class="in">    style H fill:#bbf,stroke:#333,stroke-width:2px</span></span>
<span id="cb18-62"><a href="#cb18-62" aria-hidden="true" tabindex="-1"></a><span class="in">    style M fill:#bfb,stroke:#333,stroke-width:2px</span></span>
<span id="cb18-63"><a href="#cb18-63" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-64"><a href="#cb18-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-65"><a href="#cb18-65" aria-hidden="true" tabindex="-1"></a><span class="fu">## Environment Setup</span></span>
<span id="cb18-66"><a href="#cb18-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-67"><a href="#cb18-67" aria-hidden="true" tabindex="-1"></a><span class="fu">### Prerequisites</span></span>
<span id="cb18-68"><a href="#cb18-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-69"><a href="#cb18-69" aria-hidden="true" tabindex="-1"></a>Before running this workflow, ensure you have the following system dependencies installed:</span>
<span id="cb18-70"><a href="#cb18-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-71"><a href="#cb18-71" aria-hidden="true" tabindex="-1"></a><span class="in">```bash</span></span>
<span id="cb18-72"><a href="#cb18-72" aria-hidden="true" tabindex="-1"></a><span class="co"># macOS installation</span></span>
<span id="cb18-73"><a href="#cb18-73" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install tippecanoe  <span class="co"># For MBTiles generation</span></span>
<span id="cb18-74"><a href="#cb18-74" aria-hidden="true" tabindex="-1"></a><span class="ex">brew</span> install pmtiles     <span class="co"># For PMTiles conversion</span></span>
<span id="cb18-75"><a href="#cb18-75" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-76"><a href="#cb18-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-77"><a href="#cb18-77" aria-hidden="true" tabindex="-1"></a>TODO:</span>
<span id="cb18-78"><a href="#cb18-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-79"><a href="#cb18-79" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Add instructions for Linux and Windows installations</span>
<span id="cb18-80"><a href="#cb18-80" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Add installation checks for required system dependencies</span>
<span id="cb18-81"><a href="#cb18-81" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Consider containerizing these dependencies for reproducibility</span>
<span id="cb18-82"><a href="#cb18-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-83"><a href="#cb18-83" aria-hidden="true" tabindex="-1"></a><span class="fu">### Load Required Libraries and Configure Paths</span></span>
<span id="cb18-84"><a href="#cb18-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-85"><a href="#cb18-85" aria-hidden="true" tabindex="-1"></a>This section loads all necessary R packages and sets up file paths for data processing. The workflow uses a combination of spatial data processing (<span class="in">`sf`</span>), database connectivity (<span class="in">`DBI`</span>, <span class="in">`RPostgres`</span>), and data manipulation (<span class="in">`dplyr`</span>, <span class="in">`tidyr`</span>) packages.</span>
<span id="cb18-86"><a href="#cb18-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-87"><a href="#cb18-87" aria-hidden="true" tabindex="-1"></a><span class="in">```{r setup}</span></span>
<span id="cb18-88"><a href="#cb18-88" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb18-89"><a href="#cb18-89" aria-hidden="true" tabindex="-1"></a><span class="in">#| warning: false</span></span>
<span id="cb18-90"><a href="#cb18-90" aria-hidden="true" tabindex="-1"></a><span class="in">librarian::shelf(</span></span>
<span id="cb18-91"><a href="#cb18-91" aria-hidden="true" tabindex="-1"></a><span class="in">  DBI, dplyr, DT, fs, glue, here, janitor, mapgl,</span></span>
<span id="cb18-92"><a href="#cb18-92" aria-hidden="true" tabindex="-1"></a><span class="in">  sf, tidyr, purrr, readr, RPostgres, </span></span>
<span id="cb18-93"><a href="#cb18-93" aria-hidden="true" tabindex="-1"></a><span class="in">  tibble, wdpar,</span></span>
<span id="cb18-94"><a href="#cb18-94" aria-hidden="true" tabindex="-1"></a><span class="in">  quiet = T)</span></span>
<span id="cb18-95"><a href="#cb18-95" aria-hidden="true" tabindex="-1"></a><span class="in">options(readr.show_col_types = F)</span></span>
<span id="cb18-96"><a href="#cb18-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-97"><a href="#cb18-97" aria-hidden="true" tabindex="-1"></a><span class="in"># Determine environment and set paths accordingly</span></span>
<span id="cb18-98"><a href="#cb18-98" aria-hidden="true" tabindex="-1"></a><span class="in">is_server   &lt;-  Sys.info()[["sysname"]] == "Linux"</span></span>
<span id="cb18-99"><a href="#cb18-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-100"><a href="#cb18-100" aria-hidden="true" tabindex="-1"></a><span class="in"># TODO: Consider using environment variables for these paths</span></span>
<span id="cb18-101"><a href="#cb18-101" aria-hidden="true" tabindex="-1"></a><span class="in"># TODO: Add validation that all directories exist</span></span>
<span id="cb18-102"><a href="#cb18-102" aria-hidden="true" tabindex="-1"></a><span class="in">dir_raw     &lt;- '~/My Drive/projects/oceanmetrics/data/raw/couto.thiagoba@gmail.com_indicators'</span></span>
<span id="cb18-103"><a href="#cb18-103" aria-hidden="true" tabindex="-1"></a><span class="in">dir_shp     &lt;- glue("{dir_raw}/Indicators_AllProducts_may2025/Shapefiles")</span></span>
<span id="cb18-104"><a href="#cb18-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-105"><a href="#cb18-105" aria-hidden="true" tabindex="-1"></a><span class="in"># Output file paths</span></span>
<span id="cb18-106"><a href="#cb18-106" aria-hidden="true" tabindex="-1"></a><span class="in">fid_geo     &lt;- glue("{dir_raw}/fid.geojson")        # Geometry with FID identifiers</span></span>
<span id="cb18-107"><a href="#cb18-107" aria-hidden="true" tabindex="-1"></a><span class="in">long_csv    &lt;- glue("{dir_raw}/data_long.csv")      # Long format data</span></span>
<span id="cb18-108"><a href="#cb18-108" aria-hidden="true" tabindex="-1"></a><span class="in">wide_csv    &lt;- glue("{dir_raw}/data_wide.csv")      # Wide format data  </span></span>
<span id="cb18-109"><a href="#cb18-109" aria-hidden="true" tabindex="-1"></a><span class="in">lyr_csv     &lt;- glue("{dir_raw}/layers.csv")         # Layer metadata</span></span>
<span id="cb18-110"><a href="#cb18-110" aria-hidden="true" tabindex="-1"></a><span class="in">lyr_lu_csv  &lt;- glue("{dir_raw}/layer_lookup.csv")   # Layer lookup table</span></span>
<span id="cb18-111"><a href="#cb18-111" aria-hidden="true" tabindex="-1"></a><span class="in">data_geo    &lt;- glue("{dir_raw}/indicators.geojson") # Combined GeoJSON</span></span>
<span id="cb18-112"><a href="#cb18-112" aria-hidden="true" tabindex="-1"></a><span class="in">data_mbt    &lt;- glue("{dir_raw}/indicators.mbtiles") # MBTiles output</span></span>
<span id="cb18-113"><a href="#cb18-113" aria-hidden="true" tabindex="-1"></a><span class="in">data_pmt    &lt;- glue("{dir_raw}/indicators.pmtiles") # PMTiles output</span></span>
<span id="cb18-114"><a href="#cb18-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-115"><a href="#cb18-115" aria-hidden="true" tabindex="-1"></a><span class="in"># Private credentials location</span></span>
<span id="cb18-116"><a href="#cb18-116" aria-hidden="true" tabindex="-1"></a><span class="in">dir_private &lt;- ifelse(is_server, "/share/private", "~/My Drive/private")</span></span>
<span id="cb18-117"><a href="#cb18-117" aria-hidden="true" tabindex="-1"></a><span class="in">db_pass_txt &lt;- glue("{dir_private}/msens-db_admin-pass.txt")</span></span>
<span id="cb18-118"><a href="#cb18-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-119"><a href="#cb18-119" aria-hidden="true" tabindex="-1"></a><span class="in"># TODO: Add directory existence checks</span></span>
<span id="cb18-120"><a href="#cb18-120" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-121"><a href="#cb18-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-122"><a href="#cb18-122" aria-hidden="true" tabindex="-1"></a><span class="fu">### Database Connection</span></span>
<span id="cb18-123"><a href="#cb18-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-124"><a href="#cb18-124" aria-hidden="true" tabindex="-1"></a>Connect to the PostgreSQL/PostGIS database for storing processed indicator data. The connection uses environment-specific settings to support both development (local) and production (server) environments.</span>
<span id="cb18-125"><a href="#cb18-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-126"><a href="#cb18-126" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Security Note</span></span>
<span id="cb18-127"><a href="#cb18-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-128"><a href="#cb18-128" aria-hidden="true" tabindex="-1"></a>Database credentials are stored in a separate file outside the repository for security. Ensure the password file exists at the specified location before running.</span>
<span id="cb18-129"><a href="#cb18-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-130"><a href="#cb18-130" aria-hidden="true" tabindex="-1"></a>TODO:</span>
<span id="cb18-131"><a href="#cb18-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-132"><a href="#cb18-132" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Add connection error handling and retry logic</span>
<span id="cb18-133"><a href="#cb18-133" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Consider using connection pooling for better performance</span>
<span id="cb18-134"><a href="#cb18-134" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="va">[ ]</span> Add connection validation before proceeding with data operations</span>
<span id="cb18-135"><a href="#cb18-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-136"><a href="#cb18-136" aria-hidden="true" tabindex="-1"></a><span class="in">```{r db_con}</span></span>
<span id="cb18-137"><a href="#cb18-137" aria-hidden="true" tabindex="-1"></a><span class="in">stopifnot(file.exists(db_pass_txt))</span></span>
<span id="cb18-138"><a href="#cb18-138" aria-hidden="true" tabindex="-1"></a><span class="in">con &lt;- DBI::dbConnect(</span></span>
<span id="cb18-139"><a href="#cb18-139" aria-hidden="true" tabindex="-1"></a><span class="in">  RPostgres::Postgres(),</span></span>
<span id="cb18-140"><a href="#cb18-140" aria-hidden="true" tabindex="-1"></a><span class="in">  dbname   = "msens",</span></span>
<span id="cb18-141"><a href="#cb18-141" aria-hidden="true" tabindex="-1"></a><span class="in">  host     = ifelse(is_server, "postgis", "localhost"),</span></span>
<span id="cb18-142"><a href="#cb18-142" aria-hidden="true" tabindex="-1"></a><span class="in">  port     = 5432,</span></span>
<span id="cb18-143"><a href="#cb18-143" aria-hidden="true" tabindex="-1"></a><span class="in">  user     = "admin",</span></span>
<span id="cb18-144"><a href="#cb18-144" aria-hidden="true" tabindex="-1"></a><span class="in">  password = readLines(db_pass_txt),</span></span>
<span id="cb18-145"><a href="#cb18-145" aria-hidden="true" tabindex="-1"></a><span class="in">  options  ="-c search_path=oceanmetrics,public")</span></span>
<span id="cb18-146"><a href="#cb18-146" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-147"><a href="#cb18-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-148"><a href="#cb18-148" aria-hidden="true" tabindex="-1"></a><span class="fu">## Data Transformation</span></span>
<span id="cb18-149"><a href="#cb18-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-150"><a href="#cb18-150" aria-hidden="true" tabindex="-1"></a><span class="fu">### Overview of Transformation Process</span></span>
<span id="cb18-151"><a href="#cb18-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-152"><a href="#cb18-152" aria-hidden="true" tabindex="-1"></a>The data transformation involves several key steps:</span>
<span id="cb18-153"><a href="#cb18-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-154"><a href="#cb18-154" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Metadata Extraction**: Parse filenames to extract indicator type, season, and species group</span>
<span id="cb18-155"><a href="#cb18-155" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Geometry Standardization**: Extract consistent FID-based geometries from all shapefiles</span>
<span id="cb18-156"><a href="#cb18-156" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Data Pivoting**: Transform from wide to long format for better database normalization</span>
<span id="cb18-157"><a href="#cb18-157" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Key Generation**: Create standardized layer keys for consistent referencing</span>
<span id="cb18-158"><a href="#cb18-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-159"><a href="#cb18-159" aria-hidden="true" tabindex="-1"></a><span class="fu">### Parse Shapefiles and Extract Metadata</span></span>
<span id="cb18-160"><a href="#cb18-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-161"><a href="#cb18-161" aria-hidden="true" tabindex="-1"></a>This section reads all shapefiles, extracts metadata from filenames, and prepares the data for transformation. The filename pattern follows: <span class="in">`{indicator}_{type}_{season}_{group}.shp`</span></span>
<span id="cb18-162"><a href="#cb18-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-163"><a href="#cb18-163" aria-hidden="true" tabindex="-1"></a><span class="fu">### Extract Geometry and Transform to Long Format</span></span>
<span id="cb18-164"><a href="#cb18-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-165"><a href="#cb18-165" aria-hidden="true" tabindex="-1"></a>This step extracts the spatial geometry from the shapefiles and transforms the attribute data into a long format suitable for database storage.</span>
<span id="cb18-166"><a href="#cb18-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-167"><a href="#cb18-167" aria-hidden="true" tabindex="-1"></a><span class="in">```{r shp_to_long}</span></span>
<span id="cb18-168"><a href="#cb18-168" aria-hidden="true" tabindex="-1"></a><span class="in">#| message: false</span></span>
<span id="cb18-169"><a href="#cb18-169" aria-hidden="true" tabindex="-1"></a><span class="in"># Parse shapefile filenames to extract metadata components</span></span>
<span id="cb18-170"><a href="#cb18-170" aria-hidden="true" tabindex="-1"></a><span class="in"># Filename pattern: {indicator}_{type}_{season}_{group}.shp</span></span>
<span id="cb18-171"><a href="#cb18-171" aria-hidden="true" tabindex="-1"></a><span class="in"># TODO: Add validation for expected filename pattern</span></span>
<span id="cb18-172"><a href="#cb18-172" aria-hidden="true" tabindex="-1"></a><span class="in"># TODO: Consider logging files that don't match expected pattern</span></span>
<span id="cb18-173"><a href="#cb18-173" aria-hidden="true" tabindex="-1"></a><span class="in"># TODO: Add error handling for malformed shapefiles</span></span>
<span id="cb18-174"><a href="#cb18-174" aria-hidden="true" tabindex="-1"></a><span class="in">d_shp &lt;- tibble(</span></span>
<span id="cb18-175"><a href="#cb18-175" aria-hidden="true" tabindex="-1"></a><span class="in">  path = dir_ls(dir_shp, glob = '*.shp')) |&gt; </span></span>
<span id="cb18-176"><a href="#cb18-176" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb18-177"><a href="#cb18-177" aria-hidden="true" tabindex="-1"></a><span class="in">    shp       = basename(path),</span></span>
<span id="cb18-178"><a href="#cb18-178" aria-hidden="true" tabindex="-1"></a><span class="in">    fname     = path_ext_remove(shp),</span></span>
<span id="cb18-179"><a href="#cb18-179" aria-hidden="true" tabindex="-1"></a><span class="in">    data      = map(path, ~ st_read(.x, quiet = TRUE)),</span></span>
<span id="cb18-180"><a href="#cb18-180" aria-hidden="true" tabindex="-1"></a><span class="in">    nrow      = map_int(data, nrow),</span></span>
<span id="cb18-181"><a href="#cb18-181" aria-hidden="true" tabindex="-1"></a><span class="in">    ncol      = map_int(data, ncol),</span></span>
<span id="cb18-182"><a href="#cb18-182" aria-hidden="true" tabindex="-1"></a><span class="in">    data_cols = map(data, names),</span></span>
<span id="cb18-183"><a href="#cb18-183" aria-hidden="true" tabindex="-1"></a><span class="in">    cols_chr  = map_chr(data_cols, paste, collapse = ', ')) |&gt; </span></span>
<span id="cb18-184"><a href="#cb18-184" aria-hidden="true" tabindex="-1"></a><span class="in">  separate(</span></span>
<span id="cb18-185"><a href="#cb18-185" aria-hidden="true" tabindex="-1"></a><span class="in">    fname, into = c('ind', 'type', 'season', 'group'),</span></span>
<span id="cb18-186"><a href="#cb18-186" aria-hidden="true" tabindex="-1"></a><span class="in">    sep = '_', remove = FALSE) |&gt; </span></span>
<span id="cb18-187"><a href="#cb18-187" aria-hidden="true" tabindex="-1"></a><span class="in">  select(-fname) |&gt; </span></span>
<span id="cb18-188"><a href="#cb18-188" aria-hidden="true" tabindex="-1"></a><span class="in">  relocate(shp, ind, type, season, group)</span></span>
<span id="cb18-189"><a href="#cb18-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-190"><a href="#cb18-190" aria-hidden="true" tabindex="-1"></a><span class="in"># summaries ----</span></span>
<span id="cb18-191"><a href="#cb18-191" aria-hidden="true" tabindex="-1"></a><span class="in"># table(d_shp$ind, d_shp$type)</span></span>
<span id="cb18-192"><a href="#cb18-192" aria-hidden="true" tabindex="-1"></a><span class="in">#     CumulativeUncertainty RichShape WeightedRichShape</span></span>
<span id="cb18-193"><a href="#cb18-193" aria-hidden="true" tabindex="-1"></a><span class="in"># Ind                    12        12                12</span></span>
<span id="cb18-194"><a href="#cb18-194" aria-hidden="true" tabindex="-1"></a><span class="in">#</span></span>
<span id="cb18-195"><a href="#cb18-195" aria-hidden="true" tabindex="-1"></a><span class="in"># table(d_shp$season, d_shp$group)</span></span>
<span id="cb18-196"><a href="#cb18-196" aria-hidden="true" tabindex="-1"></a><span class="in">#        All Fish Ray Red-listed Shark Turtle</span></span>
<span id="cb18-197"><a href="#cb18-197" aria-hidden="true" tabindex="-1"></a><span class="in"># summer   3    3   3          3     3      3</span></span>
<span id="cb18-198"><a href="#cb18-198" aria-hidden="true" tabindex="-1"></a><span class="in"># winter   3    3   3          3     3      3</span></span>
<span id="cb18-199"><a href="#cb18-199" aria-hidden="true" tabindex="-1"></a><span class="in">#</span></span>
<span id="cb18-200"><a href="#cb18-200" aria-hidden="true" tabindex="-1"></a><span class="in"># table(d_shp$cols_chr)</span></span>
<span id="cb18-201"><a href="#cb18-201" aria-hidden="true" tabindex="-1"></a><span class="in">#            FID, mx_mn_r, ecrg_rc, htspt_c, geometry </span></span>
<span id="cb18-202"><a href="#cb18-202" aria-hidden="true" tabindex="-1"></a><span class="in">#                                                  12 </span></span>
<span id="cb18-203"><a href="#cb18-203" aria-hidden="true" tabindex="-1"></a><span class="in">#                 FID, plt_dt_m_, plt_dt_s_, geometry </span></span>
<span id="cb18-204"><a href="#cb18-204" aria-hidden="true" tabindex="-1"></a><span class="in">#                                                  12 </span></span>
<span id="cb18-205"><a href="#cb18-205" aria-hidden="true" tabindex="-1"></a><span class="in"># FID, Uncrt_c, Uncrt_s, ecrg_ncr, ecrg_ncl, geometry </span></span>
<span id="cb18-206"><a href="#cb18-206" aria-hidden="true" tabindex="-1"></a><span class="in">#                                                  12 </span></span>
<span id="cb18-207"><a href="#cb18-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-208"><a href="#cb18-208" aria-hidden="true" tabindex="-1"></a><span class="in"># get the geometry from the first shapefile ----</span></span>
<span id="cb18-209"><a href="#cb18-209" aria-hidden="true" tabindex="-1"></a><span class="in">d_geom &lt;- d_shp$data[[1]] |&gt; </span></span>
<span id="cb18-210"><a href="#cb18-210" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb18-211"><a href="#cb18-211" aria-hidden="true" tabindex="-1"></a><span class="in">    fid = as.integer(FID)) |&gt; </span></span>
<span id="cb18-212"><a href="#cb18-212" aria-hidden="true" tabindex="-1"></a><span class="in">  select(fid) |&gt; </span></span>
<span id="cb18-213"><a href="#cb18-213" aria-hidden="true" tabindex="-1"></a><span class="in">  st_transform(4326)</span></span>
<span id="cb18-214"><a href="#cb18-214" aria-hidden="true" tabindex="-1"></a><span class="in">if (file_exists(fid_geo))</span></span>
<span id="cb18-215"><a href="#cb18-215" aria-hidden="true" tabindex="-1"></a><span class="in">  file_delete(fid_geo)</span></span>
<span id="cb18-216"><a href="#cb18-216" aria-hidden="true" tabindex="-1"></a><span class="in">write_sf(d_geom, fid_geo)</span></span>
<span id="cb18-217"><a href="#cb18-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-218"><a href="#cb18-218" aria-hidden="true" tabindex="-1"></a><span class="in"># go long with data to relate by fid to geom  ----</span></span>
<span id="cb18-219"><a href="#cb18-219" aria-hidden="true" tabindex="-1"></a><span class="in">d_long &lt;- d_shp |&gt; </span></span>
<span id="cb18-220"><a href="#cb18-220" aria-hidden="true" tabindex="-1"></a><span class="in">  select(ind, type, season, group, data) |&gt;</span></span>
<span id="cb18-221"><a href="#cb18-221" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb18-222"><a href="#cb18-222" aria-hidden="true" tabindex="-1"></a><span class="in">    data = map(data, \(x){</span></span>
<span id="cb18-223"><a href="#cb18-223" aria-hidden="true" tabindex="-1"></a><span class="in">      x |&gt; </span></span>
<span id="cb18-224"><a href="#cb18-224" aria-hidden="true" tabindex="-1"></a><span class="in">        st_drop_geometry() |&gt;</span></span>
<span id="cb18-225"><a href="#cb18-225" aria-hidden="true" tabindex="-1"></a><span class="in">        select(where(~ !is.character(.))) |&gt;</span></span>
<span id="cb18-226"><a href="#cb18-226" aria-hidden="true" tabindex="-1"></a><span class="in">        # clean_names() |&gt;</span></span>
<span id="cb18-227"><a href="#cb18-227" aria-hidden="true" tabindex="-1"></a><span class="in">        pivot_longer(</span></span>
<span id="cb18-228"><a href="#cb18-228" aria-hidden="true" tabindex="-1"></a><span class="in">          cols = -FID,</span></span>
<span id="cb18-229"><a href="#cb18-229" aria-hidden="true" tabindex="-1"></a><span class="in">          names_to = 'field', values_to = 'value') |&gt; </span></span>
<span id="cb18-230"><a href="#cb18-230" aria-hidden="true" tabindex="-1"></a><span class="in">        rename(fid = FID) } ) ) |&gt; </span></span>
<span id="cb18-231"><a href="#cb18-231" aria-hidden="true" tabindex="-1"></a><span class="in">  unnest(data) |&gt; </span></span>
<span id="cb18-232"><a href="#cb18-232" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb18-233"><a href="#cb18-233" aria-hidden="true" tabindex="-1"></a><span class="in">    fid = as.integer(fid)) |&gt; </span></span>
<span id="cb18-234"><a href="#cb18-234" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(!is.na(value))</span></span>
<span id="cb18-235"><a href="#cb18-235" aria-hidden="true" tabindex="-1"></a><span class="in">write_csv(d_long, long_csv)</span></span>
<span id="cb18-236"><a href="#cb18-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-237"><a href="#cb18-237" aria-hidden="true" tabindex="-1"></a><span class="in"># table(d_data$field)</span></span>
<span id="cb18-238"><a href="#cb18-238" aria-hidden="true" tabindex="-1"></a><span class="in"># ecrg_ncr  ecrg_rc  mx_mn_r plt_dt_m plt_dt_s  uncrt_c  uncrt_s </span></span>
<span id="cb18-239"><a href="#cb18-239" aria-hidden="true" tabindex="-1"></a><span class="in">#   334092   334092   334092   334092   334092   334092   334092</span></span>
<span id="cb18-240"><a href="#cb18-240" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-241"><a href="#cb18-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-242"><a href="#cb18-242" aria-hidden="true" tabindex="-1"></a><span class="fu">### Generate Layer Metadata and Keys</span></span>
<span id="cb18-243"><a href="#cb18-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-244"><a href="#cb18-244" aria-hidden="true" tabindex="-1"></a>This step creates standardized layer identifiers and human-readable descriptions for each unique combination of species group, indicator type, season, and field.</span>
<span id="cb18-245"><a href="#cb18-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-246"><a href="#cb18-246" aria-hidden="true" tabindex="-1"></a><span class="in">```{r long_to_lyrs}</span></span>
<span id="cb18-247"><a href="#cb18-247" aria-hidden="true" tabindex="-1"></a><span class="in"># d_long &lt;- read_csv(long_csv)</span></span>
<span id="cb18-248"><a href="#cb18-248" aria-hidden="true" tabindex="-1"></a><span class="in">d_geom &lt;- read_sf(fid_geo)</span></span>
<span id="cb18-249"><a href="#cb18-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-250"><a href="#cb18-250" aria-hidden="true" tabindex="-1"></a><span class="in">d_lyrs &lt;- d_long |&gt; </span></span>
<span id="cb18-251"><a href="#cb18-251" aria-hidden="true" tabindex="-1"></a><span class="in">  distinct(group, type, season, field) |&gt; </span></span>
<span id="cb18-252"><a href="#cb18-252" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(group, type, season, field)</span></span>
<span id="cb18-253"><a href="#cb18-253" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-254"><a href="#cb18-254" aria-hidden="true" tabindex="-1"></a><span class="in"># Create lookup table with all unique values from each column</span></span>
<span id="cb18-255"><a href="#cb18-255" aria-hidden="true" tabindex="-1"></a><span class="in">d_lyr_lu &lt;- d_lyrs |&gt; </span></span>
<span id="cb18-256"><a href="#cb18-256" aria-hidden="true" tabindex="-1"></a><span class="in">  select(group, type, season, field) |&gt; </span></span>
<span id="cb18-257"><a href="#cb18-257" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_longer(everything(), names_to = "column", values_to = "value") |&gt; </span></span>
<span id="cb18-258"><a href="#cb18-258" aria-hidden="true" tabindex="-1"></a><span class="in">  distinct() |&gt; </span></span>
<span id="cb18-259"><a href="#cb18-259" aria-hidden="true" tabindex="-1"></a><span class="in">  arrange(column, value) |&gt; </span></span>
<span id="cb18-260"><a href="#cb18-260" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb18-261"><a href="#cb18-261" aria-hidden="true" tabindex="-1"></a><span class="in">    key         = "",</span></span>
<span id="cb18-262"><a href="#cb18-262" aria-hidden="true" tabindex="-1"></a><span class="in">    description = "")</span></span>
<span id="cb18-263"><a href="#cb18-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-264"><a href="#cb18-264" aria-hidden="true" tabindex="-1"></a><span class="in"># Write to CSV</span></span>
<span id="cb18-265"><a href="#cb18-265" aria-hidden="true" tabindex="-1"></a><span class="in">if (!file_exists(lyr_lu_csv))</span></span>
<span id="cb18-266"><a href="#cb18-266" aria-hidden="true" tabindex="-1"></a><span class="in">  write_csv(d_lyr_lu, lyr_lu_csv)</span></span>
<span id="cb18-267"><a href="#cb18-267" aria-hidden="true" tabindex="-1"></a><span class="in"># Edit the lookup table manually</span></span>
<span id="cb18-268"><a href="#cb18-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-269"><a href="#cb18-269" aria-hidden="true" tabindex="-1"></a><span class="in"># Read the populated lookup table</span></span>
<span id="cb18-270"><a href="#cb18-270" aria-hidden="true" tabindex="-1"></a><span class="in">d_lyr_lu &lt;- read_csv(lyr_lu_csv)</span></span>
<span id="cb18-271"><a href="#cb18-271" aria-hidden="true" tabindex="-1"></a><span class="in">stopifnot(sum(duplicated(d_lyr_lu$key)) == 0)</span></span>
<span id="cb18-272"><a href="#cb18-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-273"><a href="#cb18-273" aria-hidden="true" tabindex="-1"></a><span class="in"># Function to get key/description per column from lookup table</span></span>
<span id="cb18-274"><a href="#cb18-274" aria-hidden="true" tabindex="-1"></a><span class="in">lu &lt;- function(val, desc_type = "k", df_lookup = d_lyr_lu) {</span></span>
<span id="cb18-275"><a href="#cb18-275" aria-hidden="true" tabindex="-1"></a><span class="in">  col      &lt;- deparse(substitute(val))</span></span>
<span id="cb18-276"><a href="#cb18-276" aria-hidden="true" tabindex="-1"></a><span class="in">  desc_col &lt;- ifelse(desc_type == "k", "key", "description")</span></span>
<span id="cb18-277"><a href="#cb18-277" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb18-278"><a href="#cb18-278" aria-hidden="true" tabindex="-1"></a><span class="in">  df_lookup |&gt; </span></span>
<span id="cb18-279"><a href="#cb18-279" aria-hidden="true" tabindex="-1"></a><span class="in">    filter(column == !!col, value == !!val) |&gt; </span></span>
<span id="cb18-280"><a href="#cb18-280" aria-hidden="true" tabindex="-1"></a><span class="in">    pull(!!desc_col)</span></span>
<span id="cb18-281"><a href="#cb18-281" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb18-282"><a href="#cb18-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-283"><a href="#cb18-283" aria-hidden="true" tabindex="-1"></a><span class="in"># Generate keys and descriptions for layers with lookup</span></span>
<span id="cb18-284"><a href="#cb18-284" aria-hidden="true" tabindex="-1"></a><span class="in">d_lyrs &lt;- d_lyrs |&gt; </span></span>
<span id="cb18-285"><a href="#cb18-285" aria-hidden="true" tabindex="-1"></a><span class="in">  rowwise() |&gt; </span></span>
<span id="cb18-286"><a href="#cb18-286" aria-hidden="true" tabindex="-1"></a><span class="in">  mutate(</span></span>
<span id="cb18-287"><a href="#cb18-287" aria-hidden="true" tabindex="-1"></a><span class="in">    key         = glue(</span></span>
<span id="cb18-288"><a href="#cb18-288" aria-hidden="true" tabindex="-1"></a><span class="in">      # key: "{group}_{field}_{season}_{type}"</span></span>
<span id="cb18-289"><a href="#cb18-289" aria-hidden="true" tabindex="-1"></a><span class="in">      "{lu(group, 'k')}_{lu(field, 'k')}_{lu(season, 'k')}_{lu(type, 'k')}"),</span></span>
<span id="cb18-290"><a href="#cb18-290" aria-hidden="true" tabindex="-1"></a><span class="in">    description = glue(</span></span>
<span id="cb18-291"><a href="#cb18-291" aria-hidden="true" tabindex="-1"></a><span class="in">      # deescription: "{group} {field} in {season} for {type}"</span></span>
<span id="cb18-292"><a href="#cb18-292" aria-hidden="true" tabindex="-1"></a><span class="in">      "{lu(group, 'd')} {lu(field, 'd')} in {lu(season, 'd')} for {lu(type, 'd')}") ) |&gt; </span></span>
<span id="cb18-293"><a href="#cb18-293" aria-hidden="true" tabindex="-1"></a><span class="in">  ungroup() |&gt; </span></span>
<span id="cb18-294"><a href="#cb18-294" aria-hidden="true" tabindex="-1"></a><span class="in">  relocate(key, group, field, season, type, description)</span></span>
<span id="cb18-295"><a href="#cb18-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-296"><a href="#cb18-296" aria-hidden="true" tabindex="-1"></a><span class="in"># Append value_min and value_max columns to d_lyrs per layer key from d_long ----</span></span>
<span id="cb18-297"><a href="#cb18-297" aria-hidden="true" tabindex="-1"></a><span class="in">d_lyrs &lt;- d_lyrs |&gt; </span></span>
<span id="cb18-298"><a href="#cb18-298" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(</span></span>
<span id="cb18-299"><a href="#cb18-299" aria-hidden="true" tabindex="-1"></a><span class="in">    d_long |&gt; </span></span>
<span id="cb18-300"><a href="#cb18-300" aria-hidden="true" tabindex="-1"></a><span class="in">      group_by(group, field, season, type) |&gt; </span></span>
<span id="cb18-301"><a href="#cb18-301" aria-hidden="true" tabindex="-1"></a><span class="in">      summarise(</span></span>
<span id="cb18-302"><a href="#cb18-302" aria-hidden="true" tabindex="-1"></a><span class="in">        value_min = min(value, na.rm = T),</span></span>
<span id="cb18-303"><a href="#cb18-303" aria-hidden="true" tabindex="-1"></a><span class="in">        value_max = max(value, na.rm = T),</span></span>
<span id="cb18-304"><a href="#cb18-304" aria-hidden="true" tabindex="-1"></a><span class="in">        .groups = "drop"),</span></span>
<span id="cb18-305"><a href="#cb18-305" aria-hidden="true" tabindex="-1"></a><span class="in">    by = join_by(group, type, season, field) )</span></span>
<span id="cb18-306"><a href="#cb18-306" aria-hidden="true" tabindex="-1"></a><span class="in">write_csv(d_lyrs, lyr_csv)</span></span>
<span id="cb18-307"><a href="#cb18-307" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-308"><a href="#cb18-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-309"><a href="#cb18-309" aria-hidden="true" tabindex="-1"></a><span class="fu">### Transform to Wide Format</span></span>
<span id="cb18-310"><a href="#cb18-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-311"><a href="#cb18-311" aria-hidden="true" tabindex="-1"></a>This step pivots the long format data back to a wide format where each layer becomes a column, making it suitable for GIS applications and web visualization.</span>
<span id="cb18-312"><a href="#cb18-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-313"><a href="#cb18-313" aria-hidden="true" tabindex="-1"></a><span class="in">```{r lyrs_to_wide}</span></span>
<span id="cb18-314"><a href="#cb18-314" aria-hidden="true" tabindex="-1"></a><span class="in"># Join long data with layer keys and descriptions ----</span></span>
<span id="cb18-315"><a href="#cb18-315" aria-hidden="true" tabindex="-1"></a><span class="in">d_wide &lt;- d_long |&gt; </span></span>
<span id="cb18-316"><a href="#cb18-316" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(</span></span>
<span id="cb18-317"><a href="#cb18-317" aria-hidden="true" tabindex="-1"></a><span class="in">    d_lyrs |&gt; </span></span>
<span id="cb18-318"><a href="#cb18-318" aria-hidden="true" tabindex="-1"></a><span class="in">      select(key, group, type, season, field), </span></span>
<span id="cb18-319"><a href="#cb18-319" aria-hidden="true" tabindex="-1"></a><span class="in">    by = join_by(group, type, season, field)) |&gt;</span></span>
<span id="cb18-320"><a href="#cb18-320" aria-hidden="true" tabindex="-1"></a><span class="in">  select(fid, key, value) |&gt; </span></span>
<span id="cb18-321"><a href="#cb18-321" aria-hidden="true" tabindex="-1"></a><span class="in">  pivot_wider(</span></span>
<span id="cb18-322"><a href="#cb18-322" aria-hidden="true" tabindex="-1"></a><span class="in">    names_from  = key,</span></span>
<span id="cb18-323"><a href="#cb18-323" aria-hidden="true" tabindex="-1"></a><span class="in">    values_from = value)</span></span>
<span id="cb18-324"><a href="#cb18-324" aria-hidden="true" tabindex="-1"></a><span class="in">write_csv(d_wide, wide_csv)</span></span>
<span id="cb18-325"><a href="#cb18-325" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-326"><a href="#cb18-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-327"><a href="#cb18-327" aria-hidden="true" tabindex="-1"></a><span class="fu">### Combine Data with Geometry</span></span>
<span id="cb18-328"><a href="#cb18-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-329"><a href="#cb18-329" aria-hidden="true" tabindex="-1"></a>This step merges the transformed attribute data with the spatial geometry to create the final spatial dataset.</span>
<span id="cb18-330"><a href="#cb18-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-331"><a href="#cb18-331" aria-hidden="true" tabindex="-1"></a><span class="in">```{r wide_to_dataset}</span></span>
<span id="cb18-332"><a href="#cb18-332" aria-hidden="true" tabindex="-1"></a><span class="in"># combine wide data and fid geometry ----</span></span>
<span id="cb18-333"><a href="#cb18-333" aria-hidden="true" tabindex="-1"></a><span class="in">d_indicators &lt;- d_wide |&gt; </span></span>
<span id="cb18-334"><a href="#cb18-334" aria-hidden="true" tabindex="-1"></a><span class="in">  left_join(</span></span>
<span id="cb18-335"><a href="#cb18-335" aria-hidden="true" tabindex="-1"></a><span class="in">    d_geom, by = join_by(fid)) |&gt; </span></span>
<span id="cb18-336"><a href="#cb18-336" aria-hidden="true" tabindex="-1"></a><span class="in">  relocate(fid) |&gt; </span></span>
<span id="cb18-337"><a href="#cb18-337" aria-hidden="true" tabindex="-1"></a><span class="in">  st_as_sf()</span></span>
<span id="cb18-338"><a href="#cb18-338" aria-hidden="true" tabindex="-1"></a><span class="in">st_geometry(d_indicators) &lt;- "geom"</span></span>
<span id="cb18-339"><a href="#cb18-339" aria-hidden="true" tabindex="-1"></a><span class="in"># mapview::mapView(d_indicators)</span></span>
<span id="cb18-340"><a href="#cb18-340" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-341"><a href="#cb18-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-342"><a href="#cb18-342" aria-hidden="true" tabindex="-1"></a><span class="fu">### Store in PostgreSQL/PostGIS Database</span></span>
<span id="cb18-343"><a href="#cb18-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-344"><a href="#cb18-344" aria-hidden="true" tabindex="-1"></a>This final transformation step writes the processed data to the PostgreSQL database with proper spatial indexing and primary key constraints.</span>
<span id="cb18-345"><a href="#cb18-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-346"><a href="#cb18-346" aria-hidden="true" tabindex="-1"></a><span class="in">```{r dataset_to_database}</span></span>
<span id="cb18-347"><a href="#cb18-347" aria-hidden="true" tabindex="-1"></a><span class="in"># write to database ----</span></span>
<span id="cb18-348"><a href="#cb18-348" aria-hidden="true" tabindex="-1"></a><span class="in"># TODO: Add transaction support for atomic writes</span></span>
<span id="cb18-349"><a href="#cb18-349" aria-hidden="true" tabindex="-1"></a><span class="in"># TODO: Add validation of successful write before proceeding</span></span>
<span id="cb18-350"><a href="#cb18-350" aria-hidden="true" tabindex="-1"></a><span class="in"># TODO: Consider adding spatial indexes for better query performance</span></span>
<span id="cb18-351"><a href="#cb18-351" aria-hidden="true" tabindex="-1"></a><span class="in">schema &lt;- "oceanmetrics"</span></span>
<span id="cb18-352"><a href="#cb18-352" aria-hidden="true" tabindex="-1"></a><span class="in">tbl    &lt;- "ds_indicators"</span></span>
<span id="cb18-353"><a href="#cb18-353" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-354"><a href="#cb18-354" aria-hidden="true" tabindex="-1"></a><span class="in">if (!dbExistsTable(con, Id(schema = schema, table = tbl))) {</span></span>
<span id="cb18-355"><a href="#cb18-355" aria-hidden="true" tabindex="-1"></a><span class="in">  d_indicators |&gt; </span></span>
<span id="cb18-356"><a href="#cb18-356" aria-hidden="true" tabindex="-1"></a><span class="in">    mutate(id = as.integer(fid)) |&gt; </span></span>
<span id="cb18-357"><a href="#cb18-357" aria-hidden="true" tabindex="-1"></a><span class="in">    select(-fid) |&gt; </span></span>
<span id="cb18-358"><a href="#cb18-358" aria-hidden="true" tabindex="-1"></a><span class="in">    st_write(con, tbl)</span></span>
<span id="cb18-359"><a href="#cb18-359" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb18-360"><a href="#cb18-360" aria-hidden="true" tabindex="-1"></a><span class="in">  # enforce SRID so shows up in tile.marinesensivity.org</span></span>
<span id="cb18-361"><a href="#cb18-361" aria-hidden="true" tabindex="-1"></a><span class="in">  dbExecute(con, glue(</span></span>
<span id="cb18-362"><a href="#cb18-362" aria-hidden="true" tabindex="-1"></a><span class="in">    "SELECT UpdateGeometrySRID('{schema}','{tbl}','geom',4326);"))</span></span>
<span id="cb18-363"><a href="#cb18-363" aria-hidden="true" tabindex="-1"></a><span class="in">  # make id the primary key</span></span>
<span id="cb18-364"><a href="#cb18-364" aria-hidden="true" tabindex="-1"></a><span class="in">  dbExecute(con, glue(</span></span>
<span id="cb18-365"><a href="#cb18-365" aria-hidden="true" tabindex="-1"></a><span class="in">    "ALTER TABLE {schema}.{tbl} ADD PRIMARY KEY (id);"))</span></span>
<span id="cb18-366"><a href="#cb18-366" aria-hidden="true" tabindex="-1"></a><span class="in">  </span></span>
<span id="cb18-367"><a href="#cb18-367" aria-hidden="true" tabindex="-1"></a><span class="in">  dbWriteTable(con, "ds_indicators_lyrs", d_lyrs, row.names = F, overwrite = T)</span></span>
<span id="cb18-368"><a href="#cb18-368" aria-hidden="true" tabindex="-1"></a><span class="in">}</span></span>
<span id="cb18-369"><a href="#cb18-369" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-370"><a href="#cb18-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-371"><a href="#cb18-371" aria-hidden="true" tabindex="-1"></a><span class="fu">## Visualize with `mapgl`</span></span>
<span id="cb18-372"><a href="#cb18-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-373"><a href="#cb18-373" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mapgl}</span></span>
<span id="cb18-374"><a href="#cb18-374" aria-hidden="true" tabindex="-1"></a><span class="in">ply_url     &lt;- "https://api.marinesensitivity.org/tilejson?table=oceanmetrics.ds_indicators"</span></span>
<span id="cb18-375"><a href="#cb18-375" aria-hidden="true" tabindex="-1"></a><span class="in">key         &lt;- "al_er_su_wr"</span></span>
<span id="cb18-376"><a href="#cb18-376" aria-hidden="true" tabindex="-1"></a><span class="in">description &lt;- d_lyrs |&gt; </span></span>
<span id="cb18-377"><a href="#cb18-377" aria-hidden="true" tabindex="-1"></a><span class="in">  filter(key == !!key) |&gt; </span></span>
<span id="cb18-378"><a href="#cb18-378" aria-hidden="true" tabindex="-1"></a><span class="in">  pull(description)</span></span>
<span id="cb18-379"><a href="#cb18-379" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-380"><a href="#cb18-380" aria-hidden="true" tabindex="-1"></a><span class="in">n_cols &lt;- 11</span></span>
<span id="cb18-381"><a href="#cb18-381" aria-hidden="true" tabindex="-1"></a><span class="in">cols &lt;- rev(RColorBrewer::brewer.pal(n_cols, "Spectral"))</span></span>
<span id="cb18-382"><a href="#cb18-382" aria-hidden="true" tabindex="-1"></a><span class="in">brks &lt;- seq(0, 1.0, length.out = n_cols)</span></span>
<span id="cb18-383"><a href="#cb18-383" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-384"><a href="#cb18-384" aria-hidden="true" tabindex="-1"></a><span class="in"># mapboxgl(</span></span>
<span id="cb18-385"><a href="#cb18-385" aria-hidden="true" tabindex="-1"></a><span class="in">#   style      = mapbox_style("dark"),</span></span>
<span id="cb18-386"><a href="#cb18-386" aria-hidden="true" tabindex="-1"></a><span class="in">maplibre(</span></span>
<span id="cb18-387"><a href="#cb18-387" aria-hidden="true" tabindex="-1"></a><span class="in">  style      = carto_style("voyager"),</span></span>
<span id="cb18-388"><a href="#cb18-388" aria-hidden="true" tabindex="-1"></a><span class="in">  projection = "globe") |&gt;</span></span>
<span id="cb18-389"><a href="#cb18-389" aria-hidden="true" tabindex="-1"></a><span class="in">  fit_bounds(d_geom, animate = F) |&gt; </span></span>
<span id="cb18-390"><a href="#cb18-390" aria-hidden="true" tabindex="-1"></a><span class="in">  add_vector_source(</span></span>
<span id="cb18-391"><a href="#cb18-391" aria-hidden="true" tabindex="-1"></a><span class="in">    id         = "src",</span></span>
<span id="cb18-392"><a href="#cb18-392" aria-hidden="true" tabindex="-1"></a><span class="in">    url        = ply_url,</span></span>
<span id="cb18-393"><a href="#cb18-393" aria-hidden="true" tabindex="-1"></a><span class="in">    promoteId  = "id") |&gt;</span></span>
<span id="cb18-394"><a href="#cb18-394" aria-hidden="true" tabindex="-1"></a><span class="in">  add_fill_layer(</span></span>
<span id="cb18-395"><a href="#cb18-395" aria-hidden="true" tabindex="-1"></a><span class="in">    id            = "ply",</span></span>
<span id="cb18-396"><a href="#cb18-396" aria-hidden="true" tabindex="-1"></a><span class="in">    source        = "src",</span></span>
<span id="cb18-397"><a href="#cb18-397" aria-hidden="true" tabindex="-1"></a><span class="in">    source_layer  = "oceanmetrics.ds_indicators",</span></span>
<span id="cb18-398"><a href="#cb18-398" aria-hidden="true" tabindex="-1"></a><span class="in">    fill_color    = interpolate(</span></span>
<span id="cb18-399"><a href="#cb18-399" aria-hidden="true" tabindex="-1"></a><span class="in">      column = key,</span></span>
<span id="cb18-400"><a href="#cb18-400" aria-hidden="true" tabindex="-1"></a><span class="in">      values = brks,</span></span>
<span id="cb18-401"><a href="#cb18-401" aria-hidden="true" tabindex="-1"></a><span class="in">      stops  = cols ),</span></span>
<span id="cb18-402"><a href="#cb18-402" aria-hidden="true" tabindex="-1"></a><span class="in">    fill_opacity  = 0.7,</span></span>
<span id="cb18-403"><a href="#cb18-403" aria-hidden="true" tabindex="-1"></a><span class="in">    tooltip       = key,</span></span>
<span id="cb18-404"><a href="#cb18-404" aria-hidden="true" tabindex="-1"></a><span class="in">    popup         = concat(</span></span>
<span id="cb18-405"><a href="#cb18-405" aria-hidden="true" tabindex="-1"></a><span class="in">      "layer column: ", key, "&lt;/pre&gt;&lt;br&gt;</span></span>
<span id="cb18-406"><a href="#cb18-406" aria-hidden="true" tabindex="-1"></a><span class="in">       feature id: ", get_column("id"), "&lt;/pre&gt;&lt;br&gt;</span></span>
<span id="cb18-407"><a href="#cb18-407" aria-hidden="true" tabindex="-1"></a><span class="in">       value: ", get_column(key) ),</span></span>
<span id="cb18-408"><a href="#cb18-408" aria-hidden="true" tabindex="-1"></a><span class="in">    hover_options = list(</span></span>
<span id="cb18-409"><a href="#cb18-409" aria-hidden="true" tabindex="-1"></a><span class="in">      fill_color   = "cyan",</span></span>
<span id="cb18-410"><a href="#cb18-410" aria-hidden="true" tabindex="-1"></a><span class="in">      fill_opacity = 1 ) ) |&gt; </span></span>
<span id="cb18-411"><a href="#cb18-411" aria-hidden="true" tabindex="-1"></a><span class="in">  add_legend(</span></span>
<span id="cb18-412"><a href="#cb18-412" aria-hidden="true" tabindex="-1"></a><span class="in">    description,</span></span>
<span id="cb18-413"><a href="#cb18-413" aria-hidden="true" tabindex="-1"></a><span class="in">    values   = c(0, 1),</span></span>
<span id="cb18-414"><a href="#cb18-414" aria-hidden="true" tabindex="-1"></a><span class="in">    colors   = cols,</span></span>
<span id="cb18-415"><a href="#cb18-415" aria-hidden="true" tabindex="-1"></a><span class="in">    position = "bottom-right") |&gt;</span></span>
<span id="cb18-416"><a href="#cb18-416" aria-hidden="true" tabindex="-1"></a><span class="in">  add_fullscreen_control(</span></span>
<span id="cb18-417"><a href="#cb18-417" aria-hidden="true" tabindex="-1"></a><span class="in">    position = "top-left") |&gt;</span></span>
<span id="cb18-418"><a href="#cb18-418" aria-hidden="true" tabindex="-1"></a><span class="in">  add_navigation_control() |&gt;</span></span>
<span id="cb18-419"><a href="#cb18-419" aria-hidden="true" tabindex="-1"></a><span class="in">  add_scale_control()</span></span>
<span id="cb18-420"><a href="#cb18-420" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-421"><a href="#cb18-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-422"><a href="#cb18-422" aria-hidden="true" tabindex="-1"></a><span class="fu">## Vector Tile Generation (Archived)</span></span>
<span id="cb18-423"><a href="#cb18-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-424"><a href="#cb18-424" aria-hidden="true" tabindex="-1"></a>**Note**: This section contains archived code for generating vector tiles. Consider updating to use the database directly for tile generation.</span>
<span id="cb18-425"><a href="#cb18-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-426"><a href="#cb18-426" aria-hidden="true" tabindex="-1"></a><span class="fu">### Background on Vector Tiles</span></span>
<span id="cb18-427"><a href="#cb18-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-428"><a href="#cb18-428" aria-hidden="true" tabindex="-1"></a>Vector tiles are an efficient way to serve spatial data for web visualization:</span>
<span id="cb18-429"><a href="#cb18-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-430"><a href="#cb18-430" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**MBTiles**: SQLite-based format for storing tiled map data</span>
<span id="cb18-431"><a href="#cb18-431" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**PMTiles**: Cloud-optimized format that can be served directly from S3</span>
<span id="cb18-432"><a href="#cb18-432" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Tippecanoe**: Tool for creating vector tiles with intelligent simplification</span>
<span id="cb18-433"><a href="#cb18-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-434"><a href="#cb18-434" aria-hidden="true" tabindex="-1"></a><span class="in">```{r stop_eval}</span></span>
<span id="cb18-435"><a href="#cb18-435" aria-hidden="true" tabindex="-1"></a><span class="in"># stop eval for now</span></span>
<span id="cb18-436"><a href="#cb18-436" aria-hidden="true" tabindex="-1"></a><span class="in">knitr::opts_chunk$set(eval = F)</span></span>
<span id="cb18-437"><a href="#cb18-437" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-438"><a href="#cb18-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-439"><a href="#cb18-439" aria-hidden="true" tabindex="-1"></a><span class="in">```{r geo_to_mbtiles}</span></span>
<span id="cb18-440"><a href="#cb18-440" aria-hidden="true" tabindex="-1"></a><span class="in"># tippecanoe(</span></span>
<span id="cb18-441"><a href="#cb18-441" aria-hidden="true" tabindex="-1"></a><span class="in">#   glue("'{normalizePath(data_geo)}'"),</span></span>
<span id="cb18-442"><a href="#cb18-442" aria-hidden="true" tabindex="-1"></a><span class="in">#   basename(data_mbt),</span></span>
<span id="cb18-443"><a href="#cb18-443" aria-hidden="true" tabindex="-1"></a><span class="in">#   layer_name   = "indicators",</span></span>
<span id="cb18-444"><a href="#cb18-444" aria-hidden="true" tabindex="-1"></a><span class="in">#   keep_geojson = T)</span></span>
<span id="cb18-445"><a href="#cb18-445" aria-hidden="true" tabindex="-1"></a><span class="in"># tippecanoe v2.78.0</span></span>
<span id="cb18-446"><a href="#cb18-446" aria-hidden="true" tabindex="-1"></a><span class="in"># 27841 features, 20167849 bytes of geometry and attributes, 17959145 bytes of string pool, 0 bytes of vertices, 0 bytes of nodes</span></span>
<span id="cb18-447"><a href="#cb18-447" aria-hidden="true" tabindex="-1"></a><span class="in"># Choosing a maxzoom of -z2 for features typically 37540 feet (11443 meters) apart, and at least 18667 feet (5690 meters) apart</span></span>
<span id="cb18-448"><a href="#cb18-448" aria-hidden="true" tabindex="-1"></a><span class="in"># Choosing a maxzoom of -z8 for resolution of about 1507 feet (459 meters) within features</span></span>
<span id="cb18-449"><a href="#cb18-449" aria-hidden="true" tabindex="-1"></a><span class="in"># tile 0/0/0 size is 4854382 with detail 12, &gt;500000    </span></span>
<span id="cb18-450"><a href="#cb18-450" aria-hidden="true" tabindex="-1"></a><span class="in"># Going to try keeping the sparsest 8.24% of the features to make it fit</span></span>
<span id="cb18-451"><a href="#cb18-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-452"><a href="#cb18-452" aria-hidden="true" tabindex="-1"></a><span class="in"># https://github.com/mapbox/tippecanoe?tab=readme-ov-file#continuous-polygon-features-states-and-provinces-visible-at-all-zoom-levels</span></span>
<span id="cb18-453"><a href="#cb18-453" aria-hidden="true" tabindex="-1"></a><span class="in">#</span></span>
<span id="cb18-454"><a href="#cb18-454" aria-hidden="true" tabindex="-1"></a><span class="in"># -zg: Automatically choose a maxzoom that should be sufficient to clearly distinguish the features and the detail within each feature</span></span>
<span id="cb18-455"><a href="#cb18-455" aria-hidden="true" tabindex="-1"></a><span class="in">#</span></span>
<span id="cb18-456"><a href="#cb18-456" aria-hidden="true" tabindex="-1"></a><span class="in"># --coalesce-densest-as-needed: If the tiles are too big at low or medium zoom levels, merge as many features together as are necessary to allow tiles to be created with those features that are still distinguished</span></span>
<span id="cb18-457"><a href="#cb18-457" aria-hidden="true" tabindex="-1"></a><span class="in">#</span></span>
<span id="cb18-458"><a href="#cb18-458" aria-hidden="true" tabindex="-1"></a><span class="in"># --extend-zooms-if-still-dropping: If even the tiles at high zoom levels are too big, keep adding zoom levels until one is reached that can represent all the features</span></span>
<span id="cb18-459"><a href="#cb18-459" aria-hidden="true" tabindex="-1"></a><span class="in"># system(glue("</span></span>
<span id="cb18-460"><a href="#cb18-460" aria-hidden="true" tabindex="-1"></a><span class="in">#   tippecanoe -o {basename(data_mbt)}  \\</span></span>
<span id="cb18-461"><a href="#cb18-461" aria-hidden="true" tabindex="-1"></a><span class="in">#     --maximum-tile-bytes=1000000      \\</span></span>
<span id="cb18-462"><a href="#cb18-462" aria-hidden="true" tabindex="-1"></a><span class="in">#     --simplification=10               \\</span></span>
<span id="cb18-463"><a href="#cb18-463" aria-hidden="true" tabindex="-1"></a><span class="in">#     -zg                               \\</span></span>
<span id="cb18-464"><a href="#cb18-464" aria-hidden="true" tabindex="-1"></a><span class="in">#     --coalesce-densest-as-needed      \\</span></span>
<span id="cb18-465"><a href="#cb18-465" aria-hidden="true" tabindex="-1"></a><span class="in">#     --extend-zooms-if-still-dropping  \\</span></span>
<span id="cb18-466"><a href="#cb18-466" aria-hidden="true" tabindex="-1"></a><span class="in">#     --force                           \\</span></span>
<span id="cb18-467"><a href="#cb18-467" aria-hidden="true" tabindex="-1"></a><span class="in">#     '{normalizePath(data_geo)}' " )</span></span>
<span id="cb18-468"><a href="#cb18-468" aria-hidden="true" tabindex="-1"></a><span class="in"># )</span></span>
<span id="cb18-469"><a href="#cb18-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-470"><a href="#cb18-470" aria-hidden="true" tabindex="-1"></a><span class="in">cmd &lt;- glue("</span></span>
<span id="cb18-471"><a href="#cb18-471" aria-hidden="true" tabindex="-1"></a><span class="in">  tippecanoe -o {basename(data_mbt)}  \\</span></span>
<span id="cb18-472"><a href="#cb18-472" aria-hidden="true" tabindex="-1"></a><span class="in">    --maximum-tile-bytes=1000000      \\</span></span>
<span id="cb18-473"><a href="#cb18-473" aria-hidden="true" tabindex="-1"></a><span class="in">    --simplification=10               \\</span></span>
<span id="cb18-474"><a href="#cb18-474" aria-hidden="true" tabindex="-1"></a><span class="in">    -zg                               \\</span></span>
<span id="cb18-475"><a href="#cb18-475" aria-hidden="true" tabindex="-1"></a><span class="in">    --coalesce-densest-as-needed      \\</span></span>
<span id="cb18-476"><a href="#cb18-476" aria-hidden="true" tabindex="-1"></a><span class="in">    --extend-zooms-if-still-dropping  \\</span></span>
<span id="cb18-477"><a href="#cb18-477" aria-hidden="true" tabindex="-1"></a><span class="in">    --force                           \\</span></span>
<span id="cb18-478"><a href="#cb18-478" aria-hidden="true" tabindex="-1"></a><span class="in">    '{normalizePath(data_geo)}' " )</span></span>
<span id="cb18-479"><a href="#cb18-479" aria-hidden="true" tabindex="-1"></a><span class="in">cat(cmd)</span></span>
<span id="cb18-480"><a href="#cb18-480" aria-hidden="true" tabindex="-1"></a><span class="in">system(cmd)</span></span>
<span id="cb18-481"><a href="#cb18-481" aria-hidden="true" tabindex="-1"></a><span class="in"># -zg: Automatically choose a maxzoom that should be sufficient to clearly distinguish the features and the detail within each feature</span></span>
<span id="cb18-482"><a href="#cb18-482" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-483"><a href="#cb18-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-484"><a href="#cb18-484" aria-hidden="true" tabindex="-1"></a><span class="in">if (file_exists(data_mbt))</span></span>
<span id="cb18-485"><a href="#cb18-485" aria-hidden="true" tabindex="-1"></a><span class="in">  file_delete(data_mbt)</span></span>
<span id="cb18-486"><a href="#cb18-486" aria-hidden="true" tabindex="-1"></a><span class="in">file_move(</span></span>
<span id="cb18-487"><a href="#cb18-487" aria-hidden="true" tabindex="-1"></a><span class="in">  basename(data_mbt),</span></span>
<span id="cb18-488"><a href="#cb18-488" aria-hidden="true" tabindex="-1"></a><span class="in">  data_mbt)</span></span>
<span id="cb18-489"><a href="#cb18-489" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-490"><a href="#cb18-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-491"><a href="#cb18-491" aria-hidden="true" tabindex="-1"></a><span class="in">```{r mbtiles_to_pmtiles}</span></span>
<span id="cb18-492"><a href="#cb18-492" aria-hidden="true" tabindex="-1"></a><span class="in">if (file_exists(data_pmt))</span></span>
<span id="cb18-493"><a href="#cb18-493" aria-hidden="true" tabindex="-1"></a><span class="in">  file_delete(data_pmt)</span></span>
<span id="cb18-494"><a href="#cb18-494" aria-hidden="true" tabindex="-1"></a><span class="in">system(glue("</span></span>
<span id="cb18-495"><a href="#cb18-495" aria-hidden="true" tabindex="-1"></a><span class="in">  pmtiles convert \\</span></span>
<span id="cb18-496"><a href="#cb18-496" aria-hidden="true" tabindex="-1"></a><span class="in">    '{normalizePath(data_mbt)}' \\</span></span>
<span id="cb18-497"><a href="#cb18-497" aria-hidden="true" tabindex="-1"></a><span class="in">    '{normalizePath(data_pmt, mustWork=F)}' " ) )</span></span>
<span id="cb18-498"><a href="#cb18-498" aria-hidden="true" tabindex="-1"></a><span class="in"># 2025/06/05 16:32:37 convert.go:159: Pass 1: Assembling TileID set</span></span>
<span id="cb18-499"><a href="#cb18-499" aria-hidden="true" tabindex="-1"></a><span class="in"># 2025/06/05 16:32:37 convert.go:190: Pass 2: writing tiles</span></span>
<span id="cb18-500"><a href="#cb18-500" aria-hidden="true" tabindex="-1"></a><span class="in">#  100% || (508/508, 1333 it/s)        </span></span>
<span id="cb18-501"><a href="#cb18-501" aria-hidden="true" tabindex="-1"></a><span class="in"># 2025/06/05 16:32:38 convert.go:244: # of addressed tiles:  508</span></span>
<span id="cb18-502"><a href="#cb18-502" aria-hidden="true" tabindex="-1"></a><span class="in"># 2025/06/05 16:32:38 convert.go:245: # of tile entries (after RLE):  508</span></span>
<span id="cb18-503"><a href="#cb18-503" aria-hidden="true" tabindex="-1"></a><span class="in"># 2025/06/05 16:32:38 convert.go:246: # of tile contents:  508</span></span>
<span id="cb18-504"><a href="#cb18-504" aria-hidden="true" tabindex="-1"></a><span class="in"># 2025/06/05 16:32:38 convert.go:269: Total dir bytes:  1621</span></span>
<span id="cb18-505"><a href="#cb18-505" aria-hidden="true" tabindex="-1"></a><span class="in"># 2025/06/05 16:32:38 convert.go:270: Average bytes per addressed tile: 3.19</span></span>
<span id="cb18-506"><a href="#cb18-506" aria-hidden="true" tabindex="-1"></a><span class="in"># 2025/06/05 16:32:38 convert.go:239: Finished in  460.858875ms</span></span>
<span id="cb18-507"><a href="#cb18-507" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-508"><a href="#cb18-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-509"><a href="#cb18-509" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pmtiles_to_s3}</span></span>
<span id="cb18-510"><a href="#cb18-510" aria-hidden="true" tabindex="-1"></a><span class="in"># [setup s3 bucket](https://oceanmetrics.github.io/workflows/explore_geoarrow.html#setup-s3-aws-bucket)</span></span>
<span id="cb18-511"><a href="#cb18-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-512"><a href="#cb18-512" aria-hidden="true" tabindex="-1"></a><span class="in">d_aws &lt;- read_csv(</span></span>
<span id="cb18-513"><a href="#cb18-513" aria-hidden="true" tabindex="-1"></a><span class="in">  '~/My Drive/private/ben_ben@ecoquants.com_console.aws.amazon.com_accessKeys.csv') |&gt; </span></span>
<span id="cb18-514"><a href="#cb18-514" aria-hidden="true" tabindex="-1"></a><span class="in">  clean_names()</span></span>
<span id="cb18-515"><a href="#cb18-515" aria-hidden="true" tabindex="-1"></a><span class="in">Sys.setenv(</span></span>
<span id="cb18-516"><a href="#cb18-516" aria-hidden="true" tabindex="-1"></a><span class="in">  "AWS_ACCESS_KEY_ID"     = d_aws$access_key_id,</span></span>
<span id="cb18-517"><a href="#cb18-517" aria-hidden="true" tabindex="-1"></a><span class="in">  "AWS_SECRET_ACCESS_KEY" = d_aws$secret_access_key,</span></span>
<span id="cb18-518"><a href="#cb18-518" aria-hidden="true" tabindex="-1"></a><span class="in">  "AWS_DEFAULT_REGION"    = "us-east-1")</span></span>
<span id="cb18-519"><a href="#cb18-519" aria-hidden="true" tabindex="-1"></a><span class="in">bucket &lt;- "oceanmetrics.io-public"</span></span>
<span id="cb18-520"><a href="#cb18-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-521"><a href="#cb18-521" aria-hidden="true" tabindex="-1"></a><span class="in"># load/reload aws.s3 to read credentials</span></span>
<span id="cb18-522"><a href="#cb18-522" aria-hidden="true" tabindex="-1"></a><span class="in"># unloadNamespace("mapboxapi")</span></span>
<span id="cb18-523"><a href="#cb18-523" aria-hidden="true" tabindex="-1"></a><span class="in">unloadNamespace("aws.s3")</span></span>
<span id="cb18-524"><a href="#cb18-524" aria-hidden="true" tabindex="-1"></a><span class="in">librarian::shelf(</span></span>
<span id="cb18-525"><a href="#cb18-525" aria-hidden="true" tabindex="-1"></a><span class="in">  aws.s3,</span></span>
<span id="cb18-526"><a href="#cb18-526" aria-hidden="true" tabindex="-1"></a><span class="in">  quiet = T)</span></span>
<span id="cb18-527"><a href="#cb18-527" aria-hidden="true" tabindex="-1"></a><span class="in"># bucketlist()</span></span>
<span id="cb18-528"><a href="#cb18-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-529"><a href="#cb18-529" aria-hidden="true" tabindex="-1"></a><span class="in">stopifnot(bucket_exists(bucket))</span></span>
<span id="cb18-530"><a href="#cb18-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-531"><a href="#cb18-531" aria-hidden="true" tabindex="-1"></a><span class="in">o      &lt;- basename(data_pmt)</span></span>
<span id="cb18-532"><a href="#cb18-532" aria-hidden="true" tabindex="-1"></a><span class="in">o_file &lt;- data_pmt</span></span>
<span id="cb18-533"><a href="#cb18-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-534"><a href="#cb18-534" aria-hidden="true" tabindex="-1"></a><span class="in">if (!object_exists(o, bucket))</span></span>
<span id="cb18-535"><a href="#cb18-535" aria-hidden="true" tabindex="-1"></a><span class="in">  put_object(o_file, o, bucket, multipart = T, verbose = F)</span></span>
<span id="cb18-536"><a href="#cb18-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-537"><a href="#cb18-537" aria-hidden="true" tabindex="-1"></a><span class="in"># put_acl(o, bucket, acl = "public-read")</span></span>
<span id="cb18-538"><a href="#cb18-538" aria-hidden="true" tabindex="-1"></a><span class="in"># "The bucket does not allow ACLs"</span></span>
<span id="cb18-539"><a href="#cb18-539" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-540"><a href="#cb18-540" aria-hidden="true" tabindex="-1"></a><span class="in"># check</span></span>
<span id="cb18-541"><a href="#cb18-541" aria-hidden="true" tabindex="-1"></a><span class="in">o_s3 &lt;- glue("s3://{bucket}/{o}")</span></span>
<span id="cb18-542"><a href="#cb18-542" aria-hidden="true" tabindex="-1"></a><span class="in">object_exists(o_s3)</span></span>
<span id="cb18-543"><a href="#cb18-543" aria-hidden="true" tabindex="-1"></a><span class="in"># s3://oceanmetrics.io-public/indicators.pmtiles</span></span>
<span id="cb18-544"><a href="#cb18-544" aria-hidden="true" tabindex="-1"></a><span class="in">url_s3 &lt;- glue("https://s3.us-east-1.amazonaws.com/{bucket}/{o}")</span></span>
<span id="cb18-545"><a href="#cb18-545" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-546"><a href="#cb18-546" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-547"><a href="#cb18-547" aria-hidden="true" tabindex="-1"></a><span class="in">```{r pmtiles_viewer}</span></span>
<span id="cb18-548"><a href="#cb18-548" aria-hidden="true" tabindex="-1"></a><span class="in">url_pmview &lt;- glue("https://pmtiles.io/#url={url_s3}")</span></span>
<span id="cb18-549"><a href="#cb18-549" aria-hidden="true" tabindex="-1"></a><span class="in">browseURL(url_pmview)</span></span>
<span id="cb18-550"><a href="#cb18-550" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-551"><a href="#cb18-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-552"><a href="#cb18-552" aria-hidden="true" tabindex="-1"></a><span class="fu">## Additional Data Sources</span></span>
<span id="cb18-553"><a href="#cb18-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-554"><a href="#cb18-554" aria-hidden="true" tabindex="-1"></a><span class="fu">### World Database on Protected Areas (WDPA)</span></span>
<span id="cb18-555"><a href="#cb18-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-556"><a href="#cb18-556" aria-hidden="true" tabindex="-1"></a>This section demonstrates how to integrate additional protected area data from WDPA, which could be overlaid with the biodiversity indicators.</span>
<span id="cb18-557"><a href="#cb18-557" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-558"><a href="#cb18-558" aria-hidden="true" tabindex="-1"></a>**TODO**: This section needs to be integrated with the main workflow or moved to a separate document.</span>
<span id="cb18-559"><a href="#cb18-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-562"><a href="#cb18-562" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-563"><a href="#cb18-563" aria-hidden="true" tabindex="-1"></a><span class="co"># rappdirs::user_data_dir("wdpar")</span></span>
<span id="cb18-564"><a href="#cb18-564" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-565"><a href="#cb18-565" aria-hidden="true" tabindex="-1"></a>dir_wdpar <span class="ot">&lt;-</span> <span class="st">"~/My Drive/projects/oceanmetrics/data/raw/wdpar"</span></span>
<span id="cb18-566"><a href="#cb18-566" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-567"><a href="#cb18-567" aria-hidden="true" tabindex="-1"></a><span class="co"># download protected area data for Malta</span></span>
<span id="cb18-568"><a href="#cb18-568" aria-hidden="true" tabindex="-1"></a>pa <span class="ot">&lt;-</span> <span class="fu">wdpa_fetch</span>(</span>
<span id="cb18-569"><a href="#cb18-569" aria-hidden="true" tabindex="-1"></a>  <span class="st">"global"</span>, <span class="at">wait =</span> <span class="cn">TRUE</span>, <span class="at">download_dir =</span> dir_wdpar)</span>
<span id="cb18-570"><a href="#cb18-570" aria-hidden="true" tabindex="-1"></a><span class="co"># Warning message:</span></span>
<span id="cb18-571"><a href="#cb18-571" aria-hidden="true" tabindex="-1"></a><span class="co"># In CPL_read_ogr(dsn, layer, query, as.character(options), quiet,  :</span></span>
<span id="cb18-572"><a href="#cb18-572" aria-hidden="true" tabindex="-1"></a><span class="co">#   GDAL Message 1: organizePolygons() received a polygon with more than 100 parts. The processing may be really slow.  You can skip the processing by setting METHOD=SKIP, or only make it analyze counter-clock wise parts by setting METHOD=ONLY_CCW if you can assume that the outline of holes is counter-clock wise defined</span></span>
<span id="cb18-573"><a href="#cb18-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-574"><a href="#cb18-574" aria-hidden="true" tabindex="-1"></a><span class="co"># clean protected area data (with procedure for erasing overlaps disabled)</span></span>
<span id="cb18-575"><a href="#cb18-575" aria-hidden="true" tabindex="-1"></a>pa_cl <span class="ot">&lt;-</span> <span class="fu">wdpa_clean</span>(pa, <span class="at">erase_overlaps =</span> <span class="cn">FALSE</span>)</span>
<span id="cb18-576"><a href="#cb18-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-577"><a href="#cb18-577" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-578"><a href="#cb18-578" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-579"><a href="#cb18-579" aria-hidden="true" tabindex="-1"></a>The <span class="in">`echo: false`</span> option disables the printing of code (only output is displayed).</span>
<span id="cb18-580"><a href="#cb18-580" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-581"><a href="#cb18-581" aria-hidden="true" tabindex="-1"></a>TODO: add PMTiles from <span class="co">[</span><span class="ot">ProtectedSeas Navigator</span><span class="co">](https://map.navigatormap.org/)</span>:</span>
<span id="cb18-582"><a href="#cb18-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-583"><a href="#cb18-583" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="ot">&lt;https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/eez.pmtiles&gt;</span></span>
<span id="cb18-584"><a href="#cb18-584" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="ot">&lt;https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/12nm.pmtiles&gt;</span></span>
<span id="cb18-585"><a href="#cb18-585" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="ot">&lt;https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp3_fill.pmtiles&gt;</span></span>
<span id="cb18-586"><a href="#cb18-586" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="ot">&lt;https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp4_fill.pmtiles&gt;</span></span>
<span id="cb18-587"><a href="#cb18-587" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="ot">&lt;https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp5_fill.pmtiles&gt;</span></span>
<span id="cb18-588"><a href="#cb18-588" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="ot">&lt;https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp1_boundaries.pmtiles&gt;</span></span>
<span id="cb18-589"><a href="#cb18-589" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="ot">&lt;https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp2_boundaries.pmtiles&gt;</span></span>
<span id="cb18-590"><a href="#cb18-590" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="ot">&lt;https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp3_boundaries.pmtiles&gt;</span></span>
<span id="cb18-591"><a href="#cb18-591" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="ot">&lt;https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp4_boundaries.pmtiles&gt;</span></span>
<span id="cb18-592"><a href="#cb18-592" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="ot">&lt;https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp5_boundaries.pmtiles&gt;</span></span>
<span id="cb18-593"><a href="#cb18-593" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-594"><a href="#cb18-594" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-597"><a href="#cb18-597" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-598"><a href="#cb18-598" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb18-599"><a href="#cb18-599" aria-hidden="true" tabindex="-1"></a>  glue, sf)</span>
<span id="cb18-600"><a href="#cb18-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-601"><a href="#cb18-601" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp3_fill.pmtiles"</span></span>
<span id="cb18-602"><a href="#cb18-602" aria-hidden="true" tabindex="-1"></a><span class="fu">system</span>(<span class="fu">glue</span>(<span class="st">"pmtiles show '{url}'"</span>))</span>
<span id="cb18-603"><a href="#cb18-603" aria-hidden="true" tabindex="-1"></a>lfp3 <span class="ot">&lt;-</span> <span class="fu">st_read</span>(url)</span>
<span id="cb18-604"><a href="#cb18-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-605"><a href="#cb18-605" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leafem)</span>
<span id="cb18-606"><a href="#cb18-606" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(leaflet)</span>
<span id="cb18-607"><a href="#cb18-607" aria-hidden="true" tabindex="-1"></a><span class="co"># url = "https://vector-tiles-data.s3.eu-central-1.amazonaws.com/rivers_africa.pmtiles"</span></span>
<span id="cb18-608"><a href="#cb18-608" aria-hidden="true" tabindex="-1"></a><span class="fu">leaflet</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-609"><a href="#cb18-609" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addTiles</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-610"><a href="#cb18-610" aria-hidden="true" tabindex="-1"></a>  <span class="fu">addPMPolylines</span>(</span>
<span id="cb18-611"><a href="#cb18-611" aria-hidden="true" tabindex="-1"></a>    <span class="at">url =</span> url</span>
<span id="cb18-612"><a href="#cb18-612" aria-hidden="true" tabindex="-1"></a>    , <span class="at">layerId =</span> <span class="st">"rivers"</span></span>
<span id="cb18-613"><a href="#cb18-613" aria-hidden="true" tabindex="-1"></a>    , <span class="at">group =</span> <span class="st">"rivers"</span></span>
<span id="cb18-614"><a href="#cb18-614" aria-hidden="true" tabindex="-1"></a>    , <span class="at">style =</span> <span class="fu">paintRules</span>(</span>
<span id="cb18-615"><a href="#cb18-615" aria-hidden="true" tabindex="-1"></a>      <span class="at">layer =</span> <span class="st">"rivers_africa"</span></span>
<span id="cb18-616"><a href="#cb18-616" aria-hidden="true" tabindex="-1"></a>      , <span class="at">color =</span> <span class="st">"blue"</span></span>
<span id="cb18-617"><a href="#cb18-617" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb18-618"><a href="#cb18-618" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb18-619"><a href="#cb18-619" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setView</span>(<span class="dv">24</span>, <span class="fl">2.5</span>, <span class="dv">4</span>)</span>
<span id="cb18-620"><a href="#cb18-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-621"><a href="#cb18-621" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-622"><a href="#cb18-622" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-623"><a href="#cb18-623" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-624"><a href="#cb18-624" aria-hidden="true" tabindex="-1"></a><span class="ot">&lt;https://pmtiles.io/#url=https%3A%2F%2Fs3.us-west-2.amazonaws.com%2Fpmtiles.navigator.protectedseas%2Flfp3_fill.pmtiles&gt;</span></span>
<span id="cb18-625"><a href="#cb18-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-628"><a href="#cb18-628" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb18-629"><a href="#cb18-629" aria-hidden="true" tabindex="-1"></a>pm_viewer <span class="ot">&lt;-</span> <span class="st">"https://pmtiles.io/#url=https%3A%2F%2Fs3.us-west-2.amazonaws.com%2Fpmtiles.navigator.protectedseas%2Flfp3_fill.pmtiles"</span></span>
<span id="cb18-630"><a href="#cb18-630" aria-hidden="true" tabindex="-1"></a><span class="fu">URLdecode</span>(pm_viewer)</span>
<span id="cb18-631"><a href="#cb18-631" aria-hidden="true" tabindex="-1"></a><span class="st">"https://pmtiles.io/#url=https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp3_fill.pmtiles"</span></span>
<span id="cb18-632"><a href="#cb18-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-633"><a href="#cb18-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-634"><a href="#cb18-634" aria-hidden="true" tabindex="-1"></a><span class="co"># devtools::install_github("walkerke/mapgl")</span></span>
<span id="cb18-635"><a href="#cb18-635" aria-hidden="true" tabindex="-1"></a>librarian<span class="sc">::</span><span class="fu">shelf</span>(</span>
<span id="cb18-636"><a href="#cb18-636" aria-hidden="true" tabindex="-1"></a>  mapgl)</span>
<span id="cb18-637"><a href="#cb18-637" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-638"><a href="#cb18-638" aria-hidden="true" tabindex="-1"></a><span class="co"># pmtiles &lt;- "https://data.source.coop/cboettig/us-boundaries/mappinginequality.pmtiles"</span></span>
<span id="cb18-639"><a href="#cb18-639" aria-hidden="true" tabindex="-1"></a><span class="co"># lyr &lt;- "mappinginequality"</span></span>
<span id="cb18-640"><a href="#cb18-640" aria-hidden="true" tabindex="-1"></a>pmtiles <span class="ot">&lt;-</span> <span class="st">"https://s3.us-west-2.amazonaws.com/pmtiles.navigator.protectedseas/lfp3_fill.pmtiles"</span></span>
<span id="cb18-641"><a href="#cb18-641" aria-hidden="true" tabindex="-1"></a>lyr <span class="ot">&lt;-</span> <span class="st">"lfp3_fill"</span></span>
<span id="cb18-642"><a href="#cb18-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-643"><a href="#cb18-643" aria-hidden="true" tabindex="-1"></a>pmtiles <span class="ot">&lt;-</span> url_s3</span>
<span id="cb18-644"><a href="#cb18-644" aria-hidden="true" tabindex="-1"></a>lyr <span class="ot">&lt;-</span> <span class="st">"indicators"</span></span>
<span id="cb18-645"><a href="#cb18-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-646"><a href="#cb18-646" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-647"><a href="#cb18-647" aria-hidden="true" tabindex="-1"></a><span class="co"># lfp3_fill Polygon</span></span>
<span id="cb18-648"><a href="#cb18-648" aria-hidden="true" tabindex="-1"></a><span class="co"># missing ID</span></span>
<span id="cb18-649"><a href="#cb18-649" aria-hidden="true" tabindex="-1"></a><span class="co"># id    668</span></span>
<span id="cb18-650"><a href="#cb18-650" aria-hidden="true" tabindex="-1"></a><span class="co"># lfp   3</span></span>
<span id="cb18-651"><a href="#cb18-651" aria-hidden="true" tabindex="-1"></a><span class="co"># last_update   2025-04-30</span></span>
<span id="cb18-652"><a href="#cb18-652" aria-hidden="true" tabindex="-1"></a><span class="co"># region_type   eez</span></span>
<span id="cb18-653"><a href="#cb18-653" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-654"><a href="#cb18-654" aria-hidden="true" tabindex="-1"></a><span class="co"># mappinginequality Polygon</span></span>
<span id="cb18-655"><a href="#cb18-655" aria-hidden="true" tabindex="-1"></a><span class="co"># missing ID</span></span>
<span id="cb18-656"><a href="#cb18-656" aria-hidden="true" tabindex="-1"></a><span class="co"># area_id   3549</span></span>
<span id="cb18-657"><a href="#cb18-657" aria-hidden="true" tabindex="-1"></a><span class="co"># city  New Haven</span></span>
<span id="cb18-658"><a href="#cb18-658" aria-hidden="true" tabindex="-1"></a><span class="co"># state CT</span></span>
<span id="cb18-659"><a href="#cb18-659" aria-hidden="true" tabindex="-1"></a><span class="co"># city_survey   true</span></span>
<span id="cb18-660"><a href="#cb18-660" aria-hidden="true" tabindex="-1"></a><span class="co"># category  Still Desirable</span></span>
<span id="cb18-661"><a href="#cb18-661" aria-hidden="true" tabindex="-1"></a><span class="co"># grade B</span></span>
<span id="cb18-662"><a href="#cb18-662" aria-hidden="true" tabindex="-1"></a><span class="co"># label B5</span></span>
<span id="cb18-663"><a href="#cb18-663" aria-hidden="true" tabindex="-1"></a><span class="co"># residential   true</span></span>
<span id="cb18-664"><a href="#cb18-664" aria-hidden="true" tabindex="-1"></a><span class="co"># commercial    false</span></span>
<span id="cb18-665"><a href="#cb18-665" aria-hidden="true" tabindex="-1"></a><span class="co"># industrial    false</span></span>
<span id="cb18-666"><a href="#cb18-666" aria-hidden="true" tabindex="-1"></a><span class="co"># fill  #7cb5bd</span></span>
<span id="cb18-667"><a href="#cb18-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-668"><a href="#cb18-668" aria-hidden="true" tabindex="-1"></a><span class="co"># m &lt;-</span></span>
<span id="cb18-669"><a href="#cb18-669" aria-hidden="true" tabindex="-1"></a><span class="fu">maplibre</span>(<span class="at">center=</span><span class="fu">c</span>(<span class="sc">-</span><span class="fl">72.9</span>, <span class="fl">41.3</span>), <span class="at">zoom=</span><span class="dv">10</span>, <span class="at">height=</span><span class="st">"400"</span>) <span class="sc">|&gt;</span></span>
<span id="cb18-670"><a href="#cb18-670" aria-hidden="true" tabindex="-1"></a><span class="co"># mapboxgl(center=c(-72.9, 41.3), zoom=10, height="400") |&gt;</span></span>
<span id="cb18-671"><a href="#cb18-671" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_vector_source</span>(</span>
<span id="cb18-672"><a href="#cb18-672" aria-hidden="true" tabindex="-1"></a>    <span class="st">"pmtile_source"</span>,</span>
<span id="cb18-673"><a href="#cb18-673" aria-hidden="true" tabindex="-1"></a>    <span class="at">url =</span> <span class="fu">paste0</span>(<span class="st">"pmtiles://"</span>, pmtiles) ) <span class="sc">|&gt;</span></span>
<span id="cb18-674"><a href="#cb18-674" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_fill_layer</span>(</span>
<span id="cb18-675"><a href="#cb18-675" aria-hidden="true" tabindex="-1"></a>    <span class="at">id           =</span> <span class="st">"pmtile_layer"</span>,</span>
<span id="cb18-676"><a href="#cb18-676" aria-hidden="true" tabindex="-1"></a>    <span class="at">source       =</span> <span class="st">"pmtile_source"</span>,</span>
<span id="cb18-677"><a href="#cb18-677" aria-hidden="true" tabindex="-1"></a>    <span class="co"># source_layer = "mappinginequality",</span></span>
<span id="cb18-678"><a href="#cb18-678" aria-hidden="true" tabindex="-1"></a>    <span class="co"># source_layer = "lfp3_fill",</span></span>
<span id="cb18-679"><a href="#cb18-679" aria-hidden="true" tabindex="-1"></a>    <span class="at">source_layer =</span> <span class="st">"indicators"</span>,</span>
<span id="cb18-680"><a href="#cb18-680" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tooltip      = "grade",</span></span>
<span id="cb18-681"><a href="#cb18-681" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tooltip      = "id",</span></span>
<span id="cb18-682"><a href="#cb18-682" aria-hidden="true" tabindex="-1"></a>    <span class="at">tooltip      =</span> <span class="st">"FID"</span>,</span>
<span id="cb18-683"><a href="#cb18-683" aria-hidden="true" tabindex="-1"></a>    <span class="co"># filter       = list(</span></span>
<span id="cb18-684"><a href="#cb18-684" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   "==", </span></span>
<span id="cb18-685"><a href="#cb18-685" aria-hidden="true" tabindex="-1"></a>    <span class="co">#   list("get", "city"), "New Haven"),</span></span>
<span id="cb18-686"><a href="#cb18-686" aria-hidden="true" tabindex="-1"></a>    <span class="co"># fill_color = list("get", "fill") </span></span>
<span id="cb18-687"><a href="#cb18-687" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill_color =</span> <span class="st">"#0000FF80"</span>)</span>
<span id="cb18-688"><a href="#cb18-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-689"><a href="#cb18-689" aria-hidden="true" tabindex="-1"></a><span class="co"># m</span></span>
<span id="cb18-690"><a href="#cb18-690" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb18-691"><a href="#cb18-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-692"><a href="#cb18-692" aria-hidden="true" tabindex="-1"></a><span class="fu">## TODO Lists and Recommendations</span></span>
<span id="cb18-693"><a href="#cb18-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-694"><a href="#cb18-694" aria-hidden="true" tabindex="-1"></a><span class="fu">### High Priority Tasks</span></span>
<span id="cb18-695"><a href="#cb18-695" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-696"><a href="#cb18-696" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Error Handling &amp; Validation**</span>
<span id="cb18-697"><a href="#cb18-697" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add comprehensive error handling for file operations</span>
<span id="cb18-698"><a href="#cb18-698" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Validate shapefile naming patterns before processing</span>
<span id="cb18-699"><a href="#cb18-699" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add transaction support for database writes</span>
<span id="cb18-700"><a href="#cb18-700" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Implement rollback mechanisms for failed operations</span>
<span id="cb18-701"><a href="#cb18-701" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add checkpoints to resume processing after failures</span>
<span id="cb18-702"><a href="#cb18-702" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-703"><a href="#cb18-703" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Performance Optimization**</span>
<span id="cb18-704"><a href="#cb18-704" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Consider parallel processing for shapefile reading</span>
<span id="cb18-705"><a href="#cb18-705" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add progress indicators for long-running operations</span>
<span id="cb18-706"><a href="#cb18-706" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Implement chunked processing for large datasets</span>
<span id="cb18-707"><a href="#cb18-707" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add spatial indexes to database tables</span>
<span id="cb18-708"><a href="#cb18-708" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Optimize tippecanoe parameters for tile generation</span>
<span id="cb18-709"><a href="#cb18-709" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-710"><a href="#cb18-710" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Configuration Management**</span>
<span id="cb18-711"><a href="#cb18-711" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Move hardcoded paths to configuration file</span>
<span id="cb18-712"><a href="#cb18-712" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Use environment variables for sensitive data</span>
<span id="cb18-713"><a href="#cb18-713" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Create separate configs for dev/staging/production</span>
<span id="cb18-714"><a href="#cb18-714" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add configuration validation at startup</span>
<span id="cb18-715"><a href="#cb18-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-716"><a href="#cb18-716" aria-hidden="true" tabindex="-1"></a><span class="fu">### Medium Priority Tasks</span></span>
<span id="cb18-717"><a href="#cb18-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-718"><a href="#cb18-718" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Documentation &amp; Logging**</span>
<span id="cb18-719"><a href="#cb18-719" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add detailed logging throughout the workflow</span>
<span id="cb18-720"><a href="#cb18-720" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Create data dictionary for all fields</span>
<span id="cb18-721"><a href="#cb18-721" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Document expected data formats and constraints</span>
<span id="cb18-722"><a href="#cb18-722" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add examples of input/output data</span>
<span id="cb18-723"><a href="#cb18-723" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Create troubleshooting guide</span>
<span id="cb18-724"><a href="#cb18-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-725"><a href="#cb18-725" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Testing &amp; Quality Assurance**</span>
<span id="cb18-726"><a href="#cb18-726" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add unit tests for key functions</span>
<span id="cb18-727"><a href="#cb18-727" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Create validation scripts for output data</span>
<span id="cb18-728"><a href="#cb18-728" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Implement data quality checks</span>
<span id="cb18-729"><a href="#cb18-729" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add integration tests for full workflow</span>
<span id="cb18-730"><a href="#cb18-730" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Create sample test datasets</span>
<span id="cb18-731"><a href="#cb18-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-732"><a href="#cb18-732" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Deployment &amp; Operations**</span>
<span id="cb18-733"><a href="#cb18-733" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Containerize the workflow (Docker/Singularity)</span>
<span id="cb18-734"><a href="#cb18-734" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Create automated deployment scripts</span>
<span id="cb18-735"><a href="#cb18-735" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add monitoring and alerting</span>
<span id="cb18-736"><a href="#cb18-736" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Implement backup strategies</span>
<span id="cb18-737"><a href="#cb18-737" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Create recovery procedures</span>
<span id="cb18-738"><a href="#cb18-738" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-739"><a href="#cb18-739" aria-hidden="true" tabindex="-1"></a><span class="fu">### Low Priority Enhancements</span></span>
<span id="cb18-740"><a href="#cb18-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-741"><a href="#cb18-741" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>**Feature Additions**</span>
<span id="cb18-742"><a href="#cb18-742" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add support for additional file formats (GeoPackage, etc.)</span>
<span id="cb18-743"><a href="#cb18-743" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Implement data versioning</span>
<span id="cb18-744"><a href="#cb18-744" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add metadata tracking (processing date, source version)</span>
<span id="cb18-745"><a href="#cb18-745" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Create data validation reports</span>
<span id="cb18-746"><a href="#cb18-746" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add support for incremental updates</span>
<span id="cb18-747"><a href="#cb18-747" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-748"><a href="#cb18-748" aria-hidden="true" tabindex="-1"></a><span class="ss">8. </span>**User Interface**</span>
<span id="cb18-749"><a href="#cb18-749" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Create web interface for workflow monitoring</span>
<span id="cb18-750"><a href="#cb18-750" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Add visualization of processing status</span>
<span id="cb18-751"><a href="#cb18-751" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Implement notification system</span>
<span id="cb18-752"><a href="#cb18-752" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span><span class="va">[ ]</span> Create admin dashboard</span>
<span id="cb18-753"><a href="#cb18-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-754"><a href="#cb18-754" aria-hidden="true" tabindex="-1"></a><span class="fu">## Key Questions for Stakeholders</span></span>
<span id="cb18-755"><a href="#cb18-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-756"><a href="#cb18-756" aria-hidden="true" tabindex="-1"></a><span class="fu">### Data Management</span></span>
<span id="cb18-757"><a href="#cb18-757" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>**Update Frequency**: How often will new indicator data be available? Should we implement automated updates?</span>
<span id="cb18-758"><a href="#cb18-758" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>**Data Retention**: What is the retention policy for historical data? Should we maintain versions?</span>
<span id="cb18-759"><a href="#cb18-759" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>**Access Control**: Who should have access to raw vs. processed data?</span>
<span id="cb18-760"><a href="#cb18-760" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-761"><a href="#cb18-761" aria-hidden="true" tabindex="-1"></a><span class="fu">### Technical Architecture</span></span>
<span id="cb18-762"><a href="#cb18-762" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>**Scalability**: What is the expected data growth over the next 2-5 years?</span>
<span id="cb18-763"><a href="#cb18-763" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>**Performance Requirements**: What are acceptable processing times for the full workflow?</span>
<span id="cb18-764"><a href="#cb18-764" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>**Integration**: What other systems need to consume this data?</span>
<span id="cb18-765"><a href="#cb18-765" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-766"><a href="#cb18-766" aria-hidden="true" tabindex="-1"></a><span class="fu">### Quality &amp; Validation</span></span>
<span id="cb18-767"><a href="#cb18-767" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>**Data Quality**: What validation rules should be enforced on input data?</span>
<span id="cb18-768"><a href="#cb18-768" aria-hidden="true" tabindex="-1"></a><span class="ss">8. </span>**Missing Data**: How should we handle missing or incomplete datasets?</span>
<span id="cb18-769"><a href="#cb18-769" aria-hidden="true" tabindex="-1"></a><span class="ss">9. </span>**Error Thresholds**: What percentage of errors is acceptable before halting processing?</span>
<span id="cb18-770"><a href="#cb18-770" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-771"><a href="#cb18-771" aria-hidden="true" tabindex="-1"></a><span class="fu">### Visualization &amp; Access</span></span>
<span id="cb18-772"><a href="#cb18-772" aria-hidden="true" tabindex="-1"></a><span class="ss">10. </span>**Tile Strategy**: Should we pre-generate all zoom levels or use dynamic tiling?</span>
<span id="cb18-773"><a href="#cb18-773" aria-hidden="true" tabindex="-1"></a><span class="ss">11. </span>**Data Formats**: Besides PMTiles, what other output formats are needed?</span>
<span id="cb18-774"><a href="#cb18-774" aria-hidden="true" tabindex="-1"></a><span class="ss">12. </span>**API Requirements**: Do we need a REST API for programmatic data access?</span>
<span id="cb18-775"><a href="#cb18-775" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-776"><a href="#cb18-776" aria-hidden="true" tabindex="-1"></a><span class="fu">## Notes on Current Implementation</span></span>
<span id="cb18-777"><a href="#cb18-777" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-778"><a href="#cb18-778" aria-hidden="true" tabindex="-1"></a><span class="fu">### Strengths</span></span>
<span id="cb18-779"><a href="#cb18-779" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Clear separation of transformation steps</span>
<span id="cb18-780"><a href="#cb18-780" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Good use of functional programming patterns</span>
<span id="cb18-781"><a href="#cb18-781" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Efficient data pivoting strategies</span>
<span id="cb18-782"><a href="#cb18-782" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Proper spatial data handling</span>
<span id="cb18-783"><a href="#cb18-783" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-784"><a href="#cb18-784" aria-hidden="true" tabindex="-1"></a><span class="fu">### Areas for Improvement</span></span>
<span id="cb18-785"><a href="#cb18-785" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Limited error handling throughout</span>
<span id="cb18-786"><a href="#cb18-786" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>No progress indication for long operations</span>
<span id="cb18-787"><a href="#cb18-787" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Hardcoded configuration values</span>
<span id="cb18-788"><a href="#cb18-788" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Missing data validation steps</span>
<span id="cb18-789"><a href="#cb18-789" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>No automated testing framework</span>
<span id="cb18-790"><a href="#cb18-790" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-791"><a href="#cb18-791" aria-hidden="true" tabindex="-1"></a><span class="fu">### Recommendations for Next Steps</span></span>
<span id="cb18-792"><a href="#cb18-792" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Start with implementing error handling and validation</span>
<span id="cb18-793"><a href="#cb18-793" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Create a configuration management system</span>
<span id="cb18-794"><a href="#cb18-794" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Add comprehensive logging</span>
<span id="cb18-795"><a href="#cb18-795" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Develop automated tests</span>
<span id="cb18-796"><a href="#cb18-796" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Document all data transformations</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>